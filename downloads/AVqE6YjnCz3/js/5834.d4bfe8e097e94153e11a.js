"use strict";(self.webpackChunkmp_webgl=self.webpackChunkmp_webgl||[]).push([[5834],{57975:e=>{function t(e){if("string"!=typeof e)throw new TypeError("Path must be a string. Received "+JSON.stringify(e))}function n(e,t){for(var n,s="",r=0,i=-1,o=0,a=0;a<=e.length;++a){if(a<e.length)n=e.charCodeAt(a);else{if(47===n)break;n=47}if(47===n){if(i===a-1||1===o);else if(i!==a-1&&2===o){if(s.length<2||2!==r||46!==s.charCodeAt(s.length-1)||46!==s.charCodeAt(s.length-2))if(s.length>2){var l=s.lastIndexOf("/");if(l!==s.length-1){-1===l?(s="",r=0):r=(s=s.slice(0,l)).length-1-s.lastIndexOf("/"),i=a,o=0;continue}}else if(2===s.length||1===s.length){s="",r=0,i=a,o=0;continue}t&&(s.length>0?s+="/..":s="..",r=2)}else s.length>0?s+="/"+e.slice(i+1,a):s=e.slice(i+1,a),r=a-i-1;i=a,o=0}else 46===n&&-1!==o?++o:o=-1}return s}var s={resolve:function(){for(var e,s="",r=!1,i=arguments.length-1;i>=-1&&!r;i--){var o;i>=0?o=arguments[i]:(void 0===e&&(e=process.cwd()),o=e),t(o),0!==o.length&&(s=o+"/"+s,r=47===o.charCodeAt(0))}return s=n(s,!r),r?s.length>0?"/"+s:"/":s.length>0?s:"."},normalize:function(e){if(t(e),0===e.length)return".";var s=47===e.charCodeAt(0),r=47===e.charCodeAt(e.length-1);return 0!==(e=n(e,!s)).length||s||(e="."),e.length>0&&r&&(e+="/"),s?"/"+e:e},isAbsolute:function(e){return t(e),e.length>0&&47===e.charCodeAt(0)},join:function(){if(0===arguments.length)return".";for(var e,n=0;n<arguments.length;++n){var r=arguments[n];t(r),r.length>0&&(void 0===e?e=r:e+="/"+r)}return void 0===e?".":s.normalize(e)},relative:function(e,n){if(t(e),t(n),e===n)return"";if((e=s.resolve(e))===(n=s.resolve(n)))return"";for(var r=1;r<e.length&&47===e.charCodeAt(r);++r);for(var i=e.length,o=i-r,a=1;a<n.length&&47===n.charCodeAt(a);++a);for(var l=n.length-a,c=o<l?o:l,h=-1,d=0;d<=c;++d){if(d===c){if(l>c){if(47===n.charCodeAt(a+d))return n.slice(a+d+1);if(0===d)return n.slice(a+d)}else o>c&&(47===e.charCodeAt(r+d)?h=d:0===d&&(h=0));break}var u=e.charCodeAt(r+d);if(u!==n.charCodeAt(a+d))break;47===u&&(h=d)}var p="";for(d=r+h+1;d<=i;++d)d!==i&&47!==e.charCodeAt(d)||(0===p.length?p+="..":p+="/..");return p.length>0?p+n.slice(a+h):(a+=h,47===n.charCodeAt(a)&&++a,n.slice(a))},_makeLong:function(e){return e},dirname:function(e){if(t(e),0===e.length)return".";for(var n=e.charCodeAt(0),s=47===n,r=-1,i=!0,o=e.length-1;o>=1;--o)if(47===(n=e.charCodeAt(o))){if(!i){r=o;break}}else i=!1;return-1===r?s?"/":".":s&&1===r?"//":e.slice(0,r)},basename:function(e,n){if(void 0!==n&&"string"!=typeof n)throw new TypeError('"ext" argument must be a string');t(e);var s,r=0,i=-1,o=!0;if(void 0!==n&&n.length>0&&n.length<=e.length){if(n.length===e.length&&n===e)return"";var a=n.length-1,l=-1;for(s=e.length-1;s>=0;--s){var c=e.charCodeAt(s);if(47===c){if(!o){r=s+1;break}}else-1===l&&(o=!1,l=s+1),a>=0&&(c===n.charCodeAt(a)?-1==--a&&(i=s):(a=-1,i=l))}return r===i?i=l:-1===i&&(i=e.length),e.slice(r,i)}for(s=e.length-1;s>=0;--s)if(47===e.charCodeAt(s)){if(!o){r=s+1;break}}else-1===i&&(o=!1,i=s+1);return-1===i?"":e.slice(r,i)},extname:function(e){t(e);for(var n=-1,s=0,r=-1,i=!0,o=0,a=e.length-1;a>=0;--a){var l=e.charCodeAt(a);if(47!==l)-1===r&&(i=!1,r=a+1),46===l?-1===n?n=a:1!==o&&(o=1):-1!==n&&(o=-1);else if(!i){s=a+1;break}}return-1===n||-1===r||0===o||1===o&&n===r-1&&n===s+1?"":e.slice(n,r)},format:function(e){if(null===e||"object"!=typeof e)throw new TypeError('The "pathObject" argument must be of type Object. Received type '+typeof e);return function(e,t){var n=t.dir||t.root,s=t.base||(t.name||"")+(t.ext||"");return n?n===t.root?n+s:n+e+s:s}("/",e)},parse:function(e){t(e);var n={root:"",dir:"",base:"",ext:"",name:""};if(0===e.length)return n;var s,r=e.charCodeAt(0),i=47===r;i?(n.root="/",s=1):s=0;for(var o=-1,a=0,l=-1,c=!0,h=e.length-1,d=0;h>=s;--h)if(47!==(r=e.charCodeAt(h)))-1===l&&(c=!1,l=h+1),46===r?-1===o?o=h:1!==d&&(d=1):-1!==o&&(d=-1);else if(!c){a=h+1;break}return-1===o||-1===l||0===d||1===d&&o===l-1&&o===a+1?-1!==l&&(n.base=n.name=0===a&&i?e.slice(1,l):e.slice(a,l)):(0===a&&i?(n.name=e.slice(1,o),n.base=e.slice(1,l)):(n.name=e.slice(a,o),n.base=e.slice(a,l)),n.ext=e.slice(o,l)),a>0?n.dir=e.slice(0,a-1):i&&(n.dir="/"),n},sep:"/",delimiter:":",win32:null,posix:null};s.posix=s,e.exports=s},10121:(e,t,n)=>{var s;n.d(t,{f:()=>s}),function(e){e[e.Standard=0]="Standard",e[e.Depth=1]="Depth",e[e.Transparent=2]="Transparent",e[e.Wireframe=3]="Wireframe",e[e.UV=4]="UV",e[e.CeilingSample=5]="CeilingSample",e[e.FloorSample=6]="FloorSample"}(s||(s={}))},75078:(e,t,n)=>{n.d(t,{$:()=>o});var s=n(37458),r=n(68909),i=n(47299);class o extends r.Mesh{constructor(e){super(),this.roomMesh=e,this.excludeFromOctree=!0,this.layers.mask=e.layers.mask,this.name=`DepthPassRoomMesh:${e.meshGroup}-${e.meshSubgroup}`,this.renderOrder=s.X.ghostFloorDepthPrepass,this.visible=!1,this.roomMesh.onOpacityUpdate=e=>{this.visible=e<i.u7.FADE_OPAQUE},this.roomMesh.onBuild=()=>{this.geometry=this.roomMesh.geometry,this.material=this.roomMesh.material},this.roomMesh.onMaterialUpdate=()=>{this.material=this.roomMesh.material};let t=!0,n=!0;this.onBeforeRender=(e,s,r,i,o,a)=>{this.roomMesh.updateUniforms(o,a),t=o.colorWrite,n=o.depthWrite,o.colorWrite=!1,o.depthWrite=!0},this.onAfterRender=(e,s,r,i,o,a)=>{o.colorWrite=t,o.depthWrite=n}}}},93121:(e,t,n)=>{n.d(t,{o:()=>c});var s=n(68909),r=n(3066),i=n(86866),o=n(47299);class a{constructor(){this._configs={},this._orders={},this._maxLod=-1/0,this._maxTs=1/0,this._streamAbove=0}static encodeKey(e,t){return e-t}get maxLod(){return this._maxLod}get maxTexelSize(){return this._maxTs}limitStreamingBelow(e){this._streamAbove=e}order(e,t=!1){return t&&!this._orders[e]&&(this._orders[e]=[]),this._orders[e]}reset(){this._configs={},this._orders={},this._maxTs=1/0,this._maxLod=-1/0}lods(){return Object.keys(this._orders).map((e=>Number.parseInt(e,10)))}valid(e){return e in this._configs}get(e){if(!this.valid(e))throw new Error("invalid quality level "+e);return this._configs[e]}max(e){return e<this._streamAbove?this.min(e):this.order(e)[this.order(e).length-1]}min(e){return this.order(e)[0]}fromPixelSize(e,t){const n=this.order(e),s=this.min(e);let r=this.max(e);for(let e=n.length-1;e>=0;e--)t>this.get(n[e]).texelSize&&n.indexOf(r)>n.indexOf(s)&&(r=n[e]);return r}moreDetailed(e,t){let n=this.min(e);const s=this.max(e),r=this.order(e),i=r.indexOf(t);return i+1===r.length?s:(-1!==i&&(n=Math.min(s,r[i+1%r.length])),n)}lessDetailed(e,t){const n=this.order(e),s=n.indexOf(t);let r=t;return-1!==s&&(r=n[Math.max(0,s-1)]),r}minSize(){return Object.values(this._configs).sort(l)[0]}maxSize(){const e=Object.values(this._configs).sort(l);return e[e.length-1]}nearestQuality(e,t){const n=this.order(e),s=this.max(e),r=(0,i.OF)(t,1,4,0,n.length-1);return Math.min(s,n[Math.round(r)])}registerQualities(e,t,n,s,r="max"){const i=this._configs,l=this.order(e,!0),c=t*s;for(let s=t,h=n;s>=c;s*=.5,h*=2){const n=a.encodeKey(e,h),c=i[n];(!c||c&&c.assetSize<t)&&(this._maxTs=Math.min(this._maxTs,h),this._maxLod=Math.max(this._maxLod,e),i[n]={key:n,lod:e,texelSize:h,textureSize:s,assetSize:t,assetType:r,tileSize:Math.min(s,o.Ay.textureTileSize)}),-1===l.indexOf(n)&&l.push(n)}l.sort(((e,t)=>i[t].texelSize-i[e].texelSize))}}function l(e,t){return e.textureSize>t.textureSize?1:-1}class c extends s.Object3D{constructor(){super(...arguments),this.boundingBox=new s.Box3,this.size=new s.Vector3,this.center=new s.Vector3,this._detail="default",this.textureQualityMap=new a,this.addToOctree=!0,this._chunks=[],this.onChunksLoaded=new Set,this.flipDownload=!0,this.flipUpload=!0}get detail(){return this._detail}get chunks(){return this._chunks}get visibleChunks(){return this._chunks}notifyOnChunksLoaded(e){return(0,r.Sh)((()=>this.onChunksLoaded.add(e)),(()=>this.onChunksLoaded.delete(e)),!0)}dispose(){for(const e of this._chunks)e.dispose();this._chunks.length=0}overrideMaxDetail(e){}}},99276:(e,t,n)=>{n.d(t,{B:()=>c});var s=n(68909),r=n(36476),i=n(30443),o=n(37458),a=n(5984),l=n(47299);class c extends a.r{constructor(e,t,n=r.H.ALL){super(),this._opacity=1,this._chunks=[],this.size=new s.Vector3,this.center=new s.Vector3,this.built=!1,this.layers.mask=n.mask,this.name=`RoomMesh:${e}-${t}`,this.meshGroup=e,this.meshSubgroup=t,this.renderOrder=o.X.default,this.castShadow=c.ShouldCastShadow,this.onBeforeRender=(e,t,n,s,r,i)=>{this.updateUniforms(r,i)}}dispose(){this.reset()}reset(){this._chunks.length=0,this.geometry.dispose(),delete this.onBuild,delete this.onOpacityUpdate,this.built=!1}addChunk(e){-1===this._chunks.indexOf(e)&&this._chunks.push(e)}getChunk(e){return this._chunks[e]}build(){if(this.built)throw new Error("build() should only be called once");if(!this._chunks.length)return;const e=(0,i.h0)(this._chunks.map((e=>e.geometry)));e.clearGroups();let t=0;this.material=[],this._chunks.forEach(((n,s)=>{n.geometry&&n.geometry.index&&(e.addGroup(t,n.geometry.index.count,s),t+=n.geometry.index.count,n.geometry.dispose(),n.geometry=e,n.notifyOnMaterialUpdated((e=>{Array.isArray(this.material)&&(this.material[s]=e),this.onMaterialUpdate&&this.onMaterialUpdate()})),n.onOpacityUpdate=e=>{this.opacity=e})})),this.geometry=e,this.geometry.computeBoundingBox(),this.geometry.computeBoundingSphere(),this.material=this._chunks.map((e=>e.material)),this.size=this.boundingBox.getSize(this.size),this.center=this.boundingBox.getCenter(this.center),this.built=!0,this.onBuild&&this.onBuild()}buildWithSingleChunk(e){if(this.built)return;const{meshGroup:t,meshSubgroup:n,lod:s}=e;this.name=`RoomMesh:${s}-${t}-${n}-${e.chunkIndex}`,this.meshGroup=t,this.meshSubgroup=n,this._chunks.push(e),e.notifyOnMaterialUpdated((e=>{this.material=e,this.onMaterialUpdate&&this.onMaterialUpdate()})),e.onOpacityUpdate=e=>{this.opacity=e},this.size=this.boundingBox.getSize(this.size),this.center=this.boundingBox.getCenter(this.center),this.built=!0,this.onBuild&&this.onBuild()}updateUniforms(e,t){e instanceof s.ShaderMaterial&&(t?this.chunks[t.materialIndex].onBeforeDraw(e):this.chunks.length&&this.chunks[0].onBeforeDraw(e))}get boundingBox(){return(0,i.UX)(this.geometry)}set opacity(e){e!==this.opacity&&(this._opacity=e,this.raycastEnabled=e>l.u7.FADE_CLICKABLE_THRESHOLD,this.renderOrder=e<l.u7.FADE_OPAQUE?o.X.ghostFloor:o.X.default,this.onOpacityUpdate&&this.onOpacityUpdate(e))}get opacity(){return this._opacity}get chunks(){return this._chunks}getSortKey(){return this.chunks.length?this._chunks[0].getSortKey():0}}c.ShouldCastShadow=!1},70497:(e,t,n)=>{var s;n.d(t,{X:()=>s}),function(e){e[e.Min=0]="Min",e[e.Standard=1]="Standard",e[e.High=2]="High",e[e.Detail=3]="Detail"}(s||(s={}))},90351:(e,t,n)=>{n.d(t,{f:()=>Ye});var s=n(36476),r=n(73927),i=n(68909);const o=new i.Vector3,a=(new i.Matrix4).set(1,0,0,0,0,0,-1,0,0,1,0,0,0,0,0,1),l=a.clone().invert();function c(e,t){if(!1!==t(e)&&e.children)for(const n of e.children)c(n,t)}function h(e,t){const{box:n,boxTransformInverse:s}=function(e){let t=d.get(e);if(!t){const n=e.boundingVolume.box,s=new i.Box3,r=new i.Matrix4,o=new i.Vector3(n[3],n[4],n[5]),a=new i.Vector3(n[6],n[7],n[8]),l=new i.Vector3(n[9],n[10],n[11]),c=o.length(),h=a.length(),u=l.length();o.normalize(),a.normalize(),l.normalize(),0===c&&o.crossVectors(a,l),0===h&&a.crossVectors(o,l),0===u&&l.crossVectors(o,a),r.set(o.x,a.x,l.x,n[0],o.y,a.y,l.y,n[1],o.z,a.z,l.z,n[2],0,0,0,1).invert(),s.min.set(-c,-h,-u),s.max.set(c,h,u),t={box:s,boxTransformInverse:r},d.set(e,t)}return t}(t);return o.copy(e).applyMatrix4(a).applyMatrix4(s),n.containsPoint(o)}const d=new WeakMap;function u(e){for(var t;e;){const n=null===(t=e.extras)||void 0===t?void 0:t.level;if("number"==typeof n)return n;e=e.parent}return-1}var p=n(83075),f=n(596),m=n(44345),g=n(93121),x=n(3066),y=n(31093),b=n(10843),w=n(79243),_=n(65936),T=n(57975);function v(e){let t;try{t=new URL(e,"http://fakehost.com/")}catch(e){return null}const n=t.pathname.split("/").pop(),s=n.lastIndexOf(".");if(-1===s||s===n.length-1)return null;return n.substring(s+1)}class S{constructor(){this.maxSize=800,this.minSize=600,this.unloadPercent=.05,this.itemSet=new Map,this.itemList=[],this.usedSet=new Set,this.callbacks=new Map,this.unloadPriorityCallback=null;const e=this.itemSet;this.defaultPriorityCallback=t=>e.get(t)}isFull(){return this.itemSet.size>=this.maxSize}add(e,t){const n=this.itemSet;if(n.has(e))return!1;if(this.isFull())return!1;const s=this.usedSet,r=this.itemList,i=this.callbacks;return r.push(e),s.add(e),n.set(e,Date.now()),i.set(e,t),!0}remove(e){const t=this.usedSet,n=this.itemSet,s=this.itemList,r=this.callbacks;if(n.has(e)){r.get(e)(e);const i=s.indexOf(e);return s.splice(i,1),t.delete(e),n.delete(e),r.delete(e),!0}return!1}markUsed(e){const t=this.itemSet,n=this.usedSet;t.has(e)&&!n.has(e)&&(t.set(e,Date.now()),n.add(e))}markAllUnused(){this.usedSet.clear()}unloadUnusedContent(){const e=this.unloadPercent,t=this.minSize,n=this.itemList,s=this.itemSet,r=this.usedSet,i=this.callbacks,o=n.length-r.size,a=n.length-t,l=this.unloadPriorityCallback||this.defaultPriorityCallback;if(a>0&&o>0){n.sort(((e,t)=>{const n=r.has(e),s=r.has(t);return n&&s?0:n||s?n?1:-1:l(t)-l(e)}));const c=Math.min(a,o),h=Math.max(t*e,c*e);let d=Math.min(h,o);d=Math.ceil(d);const u=n.splice(0,d);for(let e=0,t=u.length;e<t;e++){const t=u[e];i.get(t)(t),s.delete(t),i.delete(t)}}}scheduleUnload(e=!0){var t;this.scheduled||(this.scheduled=!0,t=()=>{this.scheduled=!1,this.unloadUnusedContent(),e&&this.markAllUnused()},Promise.resolve().then(t))}}class M{constructor(){this.maxJobs=6,this.items=[],this.callbacks=new Map,this.currJobs=0,this.scheduled=!1,this.autoUpdate=!0,this.priorityCallback=()=>{throw new Error("PriorityQueue: PriorityCallback function not defined.")},this.schedulingCallback=e=>{requestAnimationFrame(e)},this._runjobs=()=>{this.tryRunJobs(),this.scheduled=!1}}sort(){const e=this.priorityCallback;this.items.sort(e)}add(e,t){return new Promise(((n,s)=>{const r=this.items,i=this.callbacks;r.push(e),i.set(e,((...e)=>t(...e).then(n).catch(s))),this.autoUpdate&&this.scheduleJobRun()}))}remove(e){const t=this.items,n=this.callbacks,s=t.indexOf(e);-1!==s&&(t.splice(s,1),n.delete(e))}tryRunJobs(){this.sort();const e=this.items,t=this.callbacks,n=this.maxJobs;let s=this.currJobs;for(;n>s&&e.length>0;){s++;const n=e.pop(),r=t.get(n);t.delete(n),r(n).then((()=>{this.currJobs--,this.autoUpdate&&this.scheduleJobRun()})).catch((()=>{this.currJobs--,this.autoUpdate&&this.scheduleJobRun()}))}this.currJobs=s}scheduleJobRun(){this.scheduled||(this.schedulingCallback(this._runjobs),this.scheduled=!0)}}function C(e){return 3===e||4===e}function A(e,t){return e.__lastFrameVisited===t&&e.__used}function L(e,t){e.__lastFrameVisited!==t&&(e.__lastFrameVisited=t,e.__used=!1,e.__inFrustum=!1,e.__isLeaf=!1,e.__visible=!1,e.__active=!1,e.__error=1/0,e.__distanceFromCamera=1/0,e.__childrenWereVisible=!1,e.__allChildrenLoaded=!1)}function B(e,t,n){if(L(e,t),e.__used=!0,n.markUsed(e),e.__contentEmpty){const s=e.children;for(let e=0,r=s.length;e<r;e++)B(s[e],t,n)}}function P(e,t,n){if(e.__contentEmpty&&(!e.__externalTileSet||C(e.__loadingState))){const s=e.children;for(let e=0,r=s.length;e<r;e++){const r=s[e];r.__depthFromRenderedParent=t,P(r,t,n)}}else n.requestTileContents(e)}function U(e,t=null,n=null,s=null,r=0){if(t&&t(e,s,r))return void(n&&n(e,s,r));const i=e.children;for(let s=0,o=i.length;s<o;s++)U(i[s],t,n,e,r+1);n&&n(e,s,r)}function k(e,t){const n=t.stats,s=t.frameCount,r=t.errorTarget,i=t.maxDepth,o=t.loadSiblings,a=t.lruCache,l=t.stopAtEmptyTiles;L(e,s);if(!1===t.tileInView(e))return!1;if(e.__used=!0,a.markUsed(e),e.__inFrustum=!0,n.inFrustum++,(l||!e.__contentEmpty)&&!e.__externalTileSet){t.calculateError(e);if(e.__error<=r)return!0;if(t.maxDepth>0&&e.__depth+1>=i)return!0}let c=!1;const h=e.children;for(let e=0,n=h.length;e<n;e++){const n=k(h[e],t);c=c||n}if(c&&o)for(let e=0,t=h.length;e<t;e++){B(h[e],s,a)}return!0}function R(e,t){const n=t.stats,s=t.frameCount;if(!A(e,s))return;n.used++;const r=e.children;let i=!1;for(let e=0,t=r.length;e<t;e++){const t=r[e];i=i||A(t,s)}if(i){let n=!1,i=!0;for(let e=0,o=r.length;e<o;e++){const o=r[e];if(R(o,t),n=n||o.__wasSetVisible||o.__childrenWereVisible,A(o,s)){const e=o.__allChildrenLoaded||!o.__contentEmpty&&C(o.__loadingState)||o.__externalTileSet&&4===o.__loadingState;i=i&&e}}e.__childrenWereVisible=n,e.__allChildrenLoaded=i}else e.__isLeaf=!0}function V(e,t){const n=t.stats,s=t.frameCount;if(!A(e,s))return;const r=e.parent,i=r?r.__depthFromRenderedParent:-1;e.__depthFromRenderedParent=i;const o=t.lruCache;if(e.__isLeaf)return e.__depthFromRenderedParent++,void(3===e.__loadingState?(e.__inFrustum&&(e.__visible=!0,n.visible++),e.__active=!0,n.active++):o.isFull()||e.__contentEmpty&&!e.__externalTileSet||t.requestTileContents(e));const a=(t.errorTarget+1)*t.errorThreshold,l=e.__error<=a,c=l||"ADD"===e.refine,h=!e.__contentEmpty,d=h||e.__externalTileSet,u=C(e.__loadingState)&&d,p=e.__childrenWereVisible,f=e.children;let m=e.__allChildrenLoaded;if(c&&h&&e.__depthFromRenderedParent++,c&&!u&&!o.isFull()&&d&&t.requestTileContents(e),(l&&!m&&!p&&u||"ADD"===e.refine&&u)&&(e.__inFrustum&&(e.__visible=!0,n.visible++),e.__active=!0,n.active++),"ADD"!==e.refine&&l&&!m&&u)for(let n=0,r=f.length;n<r;n++){const r=f[n];A(r,s)&&!o.isFull()&&(r.__depthFromRenderedParent=e.__depthFromRenderedParent+1,P(r,r.__depthFromRenderedParent,t))}else for(let e=0,n=f.length;e<n;e++){const n=f[e];A(n,s)&&V(n,t)}}function O(e,t){const n=A(e,t.frameCount);if(n||e.__usedLastFrame){let s=!1,r=!1;n&&(s=e.__active,r=t.displayActiveTiles&&e.__active||e.__visible),e.__contentEmpty||3!==e.__loadingState||(e.__wasSetActive!==s&&t.setTileActive(e,s),e.__wasSetVisible!==r&&t.setTileVisible(e,r)),e.__wasSetActive=s,e.__wasSetVisible=r,e.__usedLastFrame=n;const i=e.children;for(let e=0,n=i.length;e<n;e++){O(i[e],t)}}}const E=(e,t)=>e.__depth!==t.__depth?e.__depth>t.__depth?-1:1:e.__inFrustum!==t.__inFrustum?e.__inFrustum?1:-1:e.__used!==t.__used?e.__used?1:-1:e.__error!==t.__error?e.__error>t.__error?1:-1:e.__distanceFromCamera!==t.__distanceFromCamera?e.__distanceFromCamera>t.__distanceFromCamera?-1:1:0,F=e=>1/(e.__depthFromRenderedParent+1);class D{get rootTileSet(){const e=this.tileSets[this.rootURL];return!e||e instanceof Promise?null:e}get root(){const e=this.rootTileSet;return e?e.root:null}constructor(e){this.tileSets={},this.rootURL=e,this.fetchOptions={},this.preprocessURL=null;const t=new S;t.unloadPriorityCallback=F;const n=new M;n.maxJobs=4,n.priorityCallback=E;const s=new M;s.maxJobs=1,s.priorityCallback=E,this.lruCache=t,this.downloadQueue=n,this.parseQueue=s,this.stats={parsing:0,downloading:0,failed:0,inFrustum:0,used:0,active:0,visible:0},this.frameCount=0,this.errorTarget=6,this.errorThreshold=1/0,this.loadSiblings=!0,this.displayActiveTiles=!1,this.maxDepth=1/0,this.stopAtEmptyTiles=!0}traverse(e,t){const n=this.tileSets[this.rootURL];n&&n.root&&U(n.root,e,t)}update(){const e=this.stats,t=this.lruCache,n=this.tileSets,s=n[this.rootURL];if(!(this.rootURL in n))return void this.loadRootTileSet(this.rootURL);if(!s||!s.root)return;const r=s.root;e.inFrustum=0,e.used=0,e.active=0,e.visible=0,this.frameCount++,k(r,this),R(r,this),V(r,this),O(r,this),t.scheduleUnload()}parseTile(e,t,n){return null}disposeTile(e){}preprocessNode(e,t,n){e.content&&(!("uri"in e.content)&&"url"in e.content&&(e.content.uri=e.content.url,delete e.content.url),e.content.uri&&(e.content.uri=function(...e){const t=/^[a-zA-Z]+:\/\//;let n=-1;for(let s=0,r=e.length;s<r;s++)t.test(e[s])&&(n=s);if(-1===n)return T.join(...e).replace(/\\/g,"/");{const s=n<=0?e:e.slice(n),r=s[0].match(t)[0];return s[0]=s[0].substring(r.length),(r+T.join(...s)).replace(/\\/g,"/")}}(n,e.content.uri)),e.content.boundingVolume&&!("box"in e.content.boundingVolume||"sphere"in e.content.boundingVolume||"region"in e.content.boundingVolume)&&delete e.content.boundingVolume),e.parent=t,e.children=e.children||[];if(e.content&&e.content.uri){const t=v(e.content.uri),n=Boolean(t&&"json"===t.toLowerCase());e.__externalTileSet=n,e.__contentEmpty=n}else e.__externalTileSet=!1,e.__contentEmpty=!0;e.__distanceFromCamera=1/0,e.__error=1/0,e.__inFrustum=!1,e.__isLeaf=!1,e.__usedLastFrame=!1,e.__used=!1,e.__wasSetVisible=!1,e.__visible=!1,e.__childrenWereVisible=!1,e.__allChildrenLoaded=!1,e.__wasSetActive=!1,e.__active=!1,e.__loadingState=0,e.__loadIndex=0,e.__loadAbort=null,e.__depthFromRenderedParent=-1,null===t?(e.__depth=0,e.refine=e.refine||"REPLACE"):(e.__depth=t.__depth+1,e.refine=e.refine||t.refine)}setTileActive(e,t){}setTileVisible(e,t){}calculateError(e){return 0}tileInView(e){return!0}fetchTileSet(e,t,n=null){return fetch(e,t).then((t=>{if(t.ok)return t.json();throw new Error(`TilesRenderer: Failed to load tileset "${e}" with status ${t.status} : ${t.statusText}`)})).then((t=>{const s=t.asset.version;console.assert("1.0"===s||"0.0"===s,'asset.version is expected to be a string of "1.0" or "0.0"');const r=T.dirname(e);return U(t.root,((e,t)=>this.preprocessNode(e,t,r)),null,n,n?n.__depth:0),t}))}loadRootTileSet(e){const t=this.tileSets;if(e in t)return t[e]instanceof Error?Promise.reject(t[e]):Promise.resolve(t[e]);{const n=this.fetchTileSet(this.preprocessURL?this.preprocessURL(e):e,this.fetchOptions).then((n=>{t[e]=n}));return n.catch((n=>{console.error(n),t[e]=n})),t[e]=n,n}}requestTileContents(e){if(0!==e.__loadingState)return;const t=this.stats,n=this.lruCache,s=this.downloadQueue,r=this.parseQueue,i=e.__externalTileSet;n.add(e,(e=>{1===e.__loadingState?(e.__loadAbort.abort(),e.__loadAbort=null):i?e.children.length=0:this.disposeTile(e),1===e.__loadingState?t.downloading--:2===e.__loadingState&&t.parsing--,e.__loadingState=0,e.__loadIndex++,r.remove(e),s.remove(e)})),e.__loadIndex++;const o=e.__loadIndex,a=new AbortController,l=a.signal;t.downloading++,e.__loadAbort=a,e.__loadingState=1;const c=i=>{e.__loadIndex===o&&("AbortError"!==i.name?(r.remove(e),s.remove(e),2===e.__loadingState?t.parsing--:1===e.__loadingState&&t.downloading--,t.failed++,console.error(`TilesRenderer : Failed to load tile at url "${e.content.uri}".`),console.error(i),e.__loadingState=4):n.remove(e))};i?s.add(e,(e=>{if(e.__loadIndex!==o)return Promise.resolve();const t=this.preprocessURL?this.preprocessURL(e.content.uri):e.content.uri;return this.fetchTileSet(t,Object.assign({signal:l},this.fetchOptions),e)})).then((n=>{e.__loadIndex===o&&(t.downloading--,e.__loadAbort=null,e.__loadingState=3,e.children.push(n.root))})).catch(c):s.add(e,(e=>{if(e.__loadIndex!==o)return Promise.resolve();const t=this.preprocessURL?this.preprocessURL(e.content.uri):e.content.uri;return fetch(t,Object.assign({signal:l},this.fetchOptions))})).then((t=>{if(e.__loadIndex===o){if(t.ok)return t.arrayBuffer();throw new Error(`Failed to load model with error code ${t.status}`)}})).then((n=>{if(e.__loadIndex===o)return t.downloading--,t.parsing++,e.__loadAbort=null,e.__loadingState=2,r.add(e,(e=>{if(e.__loadIndex!==o)return Promise.resolve();const t=v(e.content.uri);return this.parseTile(n,e,t)}))})).then((()=>{e.__loadIndex===o&&(t.parsing--,e.__loadingState=3,e.__wasSetVisible&&this.setTileVisible(e,!0),e.__wasSetActive&&this.setTileActive(e,!0))})).catch(c)}dispose(){const e=this.lruCache;this.traverse((t=>{e.remove(t)}))}}function I(e){return(new TextDecoder).decode(e)}class z{constructor(e,t,n,s){this.buffer=e,this.binOffset=t+n,this.binLength=s;let r=null;if(0!==n){const s=new Uint8Array(e,t,n);r=JSON.parse(I(s))}else r={};this.header=r}getKeys(){return Object.keys(this.header)}getData(e,t,n=null,s=null){const r=this.header;if(!(e in r))return null;const i=r[e];if(i instanceof Object){if(Array.isArray(i))return i;{const{buffer:r,binOffset:o,binLength:a}=this,l=i.byteOffset||0,c=i.type||s,h=i.componentType||n;if("type"in i&&s&&i.type!==s)throw new Error("FeatureTable: Specified type does not match expected type.");let d,u;switch(c){case"SCALAR":d=1;break;case"VEC2":d=2;break;case"VEC3":d=3;break;case"VEC4":d=4;break;default:throw new Error(`FeatureTable : Feature type not provided for "${e}".`)}const p=o+l,f=t*d;switch(h){case"BYTE":u=new Int8Array(r,p,f);break;case"UNSIGNED_BYTE":u=new Uint8Array(r,p,f);break;case"SHORT":u=new Int16Array(r,p,f);break;case"UNSIGNED_SHORT":u=new Uint16Array(r,p,f);break;case"INT":u=new Int32Array(r,p,f);break;case"UNSIGNED_INT":u=new Uint32Array(r,p,f);break;case"FLOAT":u=new Float32Array(r,p,f);break;case"DOUBLE":u=new Float64Array(r,p,f);break;default:throw new Error(`FeatureTable : Feature component type not provided for "${e}".`)}if(p+f*u.BYTES_PER_ELEMENT>o+a)throw new Error("FeatureTable: Feature data read outside binary body length.");return u}}return i}}class N extends z{constructor(e,t,n,s,r){super(e,n,s,r),this.batchSize=t}getData(e,t=null,n=null){return super.getData(e,this.batchSize,t,n)}}class H{constructor(){this.fetchOptions={},this.workingPath=""}load(e){return fetch(e,this.fetchOptions).then((t=>{if(!t.ok)throw new Error(`Failed to load file "${e}" with status ${t.status} : ${t.statusText}`);return t.arrayBuffer()})).then((t=>(""===this.workingPath&&(this.workingPath=this.workingPathForURL(e)),this.parse(t))))}resolveExternalURL(e){return/^[^\\/]/.test(e)?this.workingPath+"/"+e:e}workingPathForURL(e){const t=e.split(/[\\/]/g);t.pop();return t.join("/")+"/"}parse(e){throw new Error("LoaderBase: Parse not implemented.")}}class G extends H{parse(e){const t=new DataView(e),n=String.fromCharCode(t.getUint8(0))+String.fromCharCode(t.getUint8(1))+String.fromCharCode(t.getUint8(2))+String.fromCharCode(t.getUint8(3));console.assert("b3dm"===n);const s=t.getUint32(4,!0);console.assert(1===s);const r=t.getUint32(8,!0);console.assert(r===e.byteLength);const i=t.getUint32(12,!0),o=t.getUint32(16,!0),a=t.getUint32(20,!0),l=t.getUint32(24,!0),c=e.slice(28,28+i+o),h=new z(c,0,i,o),d=28+i+o,u=e.slice(d,d+a+l),p=new N(u,h.getData("BATCH_LENGTH"),0,a,l),f=d+a+l;return{version:s,featureTable:h,batchTable:p,glbBytes:new Uint8Array(e,f,r-f)}}}var j=n(17888);class W extends G{constructor(e=i.DefaultLoadingManager){super(),this.manager=e}parse(e){const t=super.parse(e),n=t.glbBytes.slice().buffer;return new Promise(((e,s)=>{const r=this.manager,i=this.fetchOptions,o=r.getHandler("path.gltf")||new j.GLTFLoader(r);"include"===i.credentials&&"cors"===i.mode&&o.setCrossOrigin("use-credentials"),"credentials"in i&&o.setWithCredentials("include"===i.credentials),i.headers&&o.setRequestHeader(i.headers);let a=this.workingPath;!/[\\/]$/.test(a)&&a.length&&(a+="/"),o.parse(n,a,(n=>{const{batchTable:s,featureTable:r}=t,{scene:i}=n,o=r.getData("RTC_CENTER");o&&(i.position.x+=o[0],i.position.y+=o[1],i.position.z+=o[2]),n.batchTable=s,n.featureTable=r,i.batchTable=s,i.featureTable=r,e(n)}),s)}))}}class $ extends H{parse(e){const t=new DataView(e),n=String.fromCharCode(t.getUint8(0))+String.fromCharCode(t.getUint8(1))+String.fromCharCode(t.getUint8(2))+String.fromCharCode(t.getUint8(3));console.assert("pnts"===n);const s=t.getUint32(4,!0);console.assert(1===s);const r=t.getUint32(8,!0);console.assert(r===e.byteLength);const i=t.getUint32(12,!0),o=t.getUint32(16,!0),a=t.getUint32(20,!0),l=t.getUint32(24,!0),c=e.slice(28,28+i+o),h=new z(c,0,i,o),d=28+i+o,u=e.slice(d,d+a+l),p=new N(u,h.getData("BATCH_LENGTH")||h.getData("POINTS_LENGTH"),0,a,l);return Promise.resolve({version:s,featureTable:h,batchTable:p})}}class Q extends ${constructor(e=i.DefaultLoadingManager){super(),this.manager=e}parse(e){return super.parse(e).then((e=>{const{featureTable:t}=e,n=t.getData("POINTS_LENGTH"),s=t.getData("POSITION",n,"FLOAT","VEC3"),r=t.getData("RGB",n,"UNSIGNED_BYTE","VEC3");["RTC_CENTER","QUANTIZED_VOLUME_OFFSET","QUANTIZED_VOLUME_SCALE","CONSTANT_RGBA","BATCH_LENGTH","POSITION_QUANTIZED","RGBA","RGB565","NORMAL","NORMAL_OCT16P"].forEach((e=>{e in t.header&&console.warn(`PNTSLoader: Unsupported FeatureTable feature "${e}" detected.`)}));const o=new i.BufferGeometry;o.setAttribute("position",new i.BufferAttribute(s,3,!1));const a=new i.PointsMaterial;a.size=2,a.sizeAttenuation=!1,null!==r&&(o.setAttribute("color",new i.BufferAttribute(r,3,!0)),a.vertexColors=!0);const l=new i.Points(o,a);e.scene=l,e.scene.featureTable=t;const c=t.getData("RTC_CENTER");return c&&(e.scene.position.x+=c[0],e.scene.position.y+=c[1],e.scene.position.z+=c[2]),e}))}}class q extends H{parse(e){const t=new DataView(e),n=String.fromCharCode(t.getUint8(0))+String.fromCharCode(t.getUint8(1))+String.fromCharCode(t.getUint8(2))+String.fromCharCode(t.getUint8(3));console.assert("i3dm"===n);const s=t.getUint32(4,!0);console.assert(1===s);const r=t.getUint32(8,!0);console.assert(r===e.byteLength);const i=t.getUint32(12,!0),o=t.getUint32(16,!0),a=t.getUint32(20,!0),l=t.getUint32(24,!0),c=t.getUint32(28,!0),h=e.slice(32,32+i+o),d=new z(h,0,i,o),u=32+i+o,p=e.slice(u,u+a+l),f=new N(p,d.getData("INSTANCES_LENGTH"),0,a,l),m=u+a+l,g=new Uint8Array(e,m,r-m);let x=null,y=null;if(c)x=g,y=Promise.resolve();else{const e=this.resolveExternalURL(I(g));y=fetch(e,this.fetchOptions).then((t=>{if(!t.ok)throw new Error(`I3DMLoaderBase : Failed to load file "${e}" with status ${t.status} : ${t.statusText}`);return t.arrayBuffer()})).then((e=>{x=new Uint8Array(e)}))}return y.then((()=>({version:s,featureTable:d,batchTable:f,glbBytes:x})))}}const X=new i.Vector3,J=new i.Vector3,Z=new i.Vector3,K=new i.Vector3,Y=new i.Quaternion,ee=new i.Vector3,te=new i.Matrix4;class ne extends q{constructor(e=i.DefaultLoadingManager){super(),this.manager=e}resolveExternalURL(e){return this.manager.resolveURL(super.resolveExternalURL(e))}parse(e){return super.parse(e).then((e=>{const{featureTable:t,batchTable:n}=e,s=e.glbBytes.slice().buffer;return new Promise(((e,r)=>{const o=this.fetchOptions,a=this.manager,l=a.getHandler("path.gltf")||new j.GLTFLoader(a);"include"===o.credentials&&"cors"===o.mode&&l.setCrossOrigin("use-credentials"),"credentials"in o&&l.setWithCredentials("include"===o.credentials),o.headers&&l.setRequestHeader(o.headers);let c=this.workingPath;/[\\/]$/.test(c)||(c+="/"),l.parse(s,c,(s=>{const r=t.getData("INSTANCES_LENGTH"),o=t.getData("POSITION",r,"FLOAT","VEC3"),a=t.getData("NORMAL_UP",r,"FLOAT","VEC3"),l=t.getData("NORMAL_RIGHT",r,"FLOAT","VEC3"),c=t.getData("SCALE_NON_UNIFORM",r,"FLOAT","VEC3"),h=t.getData("SCALE",r,"FLOAT","SCALAR");["RTC_CENTER","QUANTIZED_VOLUME_OFFSET","QUANTIZED_VOLUME_SCALE","EAST_NORTH_UP","POSITION_QUANTIZED","NORMAL_UP_OCT32P","NORMAL_RIGHT_OCT32P"].forEach((e=>{e in t.header&&console.warn(`I3DMLoader: Unsupported FeatureTable feature "${e}" detected.`)}));const d=new Map,u=[];s.scene.traverse((e=>{if(e.isMesh){const{geometry:t,material:n}=e,s=new i.InstancedMesh(t,n,r);s.position.copy(e.position),s.rotation.copy(e.rotation),s.scale.copy(e.scale),u.push(s),d.set(e,s)}}));const p=new i.Vector3;for(let e=0;e<r;e++)p.x+=o[3*e+0]/r,p.y+=o[3*e+1]/r,p.z+=o[3*e+2]/r;d.forEach(((e,t)=>{const n=t.parent;n&&(n.remove(t),n.add(e),e.updateMatrixWorld(),e.position.copy(p).applyMatrix4(e.matrixWorld))}));for(let e=0;e<r;e++){K.set(o[3*e+0]-p.x,o[3*e+1]-p.y,o[3*e+2]-p.z),a?(J.set(a[3*e+0],a[3*e+1],a[3*e+2]),Z.set(l[3*e+0],l[3*e+1],l[3*e+2]),X.crossVectors(Z,J).normalize(),te.makeBasis(Z,J,X),Y.setFromRotationMatrix(te)):Y.set(0,0,0,1),h?ee.setScalar(h[e]):c?ee.set(c[3*e+0],c[3*e+1],c[3*e+2]):ee.set(1,1,1),te.compose(K,Y,ee);for(let t=0,n=u.length;t<n;t++){u[t].setMatrixAt(e,te)}}s.batchTable=n,s.featureTable=t,s.scene.batchTable=n,s.scene.featureTable=t,e(s)}),r)}))}))}}class se extends H{parse(e){const t=new DataView(e),n=String.fromCharCode(t.getUint8(0))+String.fromCharCode(t.getUint8(1))+String.fromCharCode(t.getUint8(2))+String.fromCharCode(t.getUint8(3));console.assert("cmpt"===n,'CMPTLoader: The magic bytes equal "cmpt".');const s=t.getUint32(4,!0);console.assert(1===s,'CMPTLoader: The version listed in the header is "1".');const r=t.getUint32(8,!0);console.assert(r===e.byteLength,"CMPTLoader: The contents buffer length listed in the header matches the file.");const i=t.getUint32(12,!0),o=[];let a=16;for(let t=0;t<i;t++){const t=new DataView(e,a,12),n=String.fromCharCode(t.getUint8(0))+String.fromCharCode(t.getUint8(1))+String.fromCharCode(t.getUint8(2))+String.fromCharCode(t.getUint8(3)),s=t.getUint32(4,!0),r=t.getUint32(8,!0),i=new Uint8Array(e,a,r);o.push({type:n,buffer:i,version:s}),a+=r}return{version:s,tiles:o}}}class re extends se{constructor(e=i.DefaultLoadingManager){super(),this.manager=e}parse(e){const t=super.parse(e),n=this.manager,s=[];for(const e in t.tiles){const{type:r,buffer:i}=t.tiles[e];switch(r){case"b3dm":{const e=i.slice(),t=new W(n);t.workingPath=this.workingPath,t.fetchOptions=this.fetchOptions;const r=t.parse(e.buffer);s.push(r);break}case"pnts":{const e=i.slice(),t=new Q(n);t.workingPath=this.workingPath,t.fetchOptions=this.fetchOptions;const r=t.parse(e.buffer);s.push(r);break}case"i3dm":{const e=i.slice(),t=new ne(n);t.workingPath=this.workingPath,t.fetchOptions=this.fetchOptions;const r=t.parse(e.buffer);s.push(r);break}}}return Promise.all(s).then((e=>{const t=new i.Group;return e.forEach((e=>{t.add(e.scene)})),{tiles:e,scene:t}}))}}class ie extends H{constructor(e=i.DefaultLoadingManager){super(),this.manager=e}parse(e){return new Promise(((t,n)=>{const s=this.manager,r=this.fetchOptions;let i=s.getHandler("path.gltf")||s.getHandler("path.glb");i||(i=new j.GLTFLoader(s),"include"===r.credentials&&"cors"===r.mode&&i.setCrossOrigin("use-credentials"),"credentials"in r&&i.setWithCredentials("include"===r.credentials),r.headers&&i.setRequestHeader(r.headers));let o=i.resourcePath||i.path||this.workingPath;!/[\\/]$/.test(o)&&o.length&&(o+="/"),i.parse(e,o,(e=>{t(e)}),n)}))}}const oe=new i.Matrix4;class ae extends i.Group{constructor(e){super(),this.name="TilesRenderer.TilesGroup",this.tilesRenderer=e}raycast(e,t){this.tilesRenderer.optimizeRaycast&&this.tilesRenderer.raycast(e,t)}updateMatrixWorld(e){if(this.matrixAutoUpdate&&this.updateMatrix(),this.matrixWorldNeedsUpdate||e){null===this.parent?oe.copy(this.matrix):oe.multiplyMatrices(this.parent.matrixWorld,this.matrix),this.matrixWorldNeedsUpdate=!1;const e=oe.elements,t=this.matrixWorld.elements;let n=!1;for(let s=0;s<16;s++){const r=e[s],i=t[s];if(Math.abs(r-i)>Number.EPSILON){n=!0;break}}if(n){this.matrixWorld.copy(oe);const e=this.children;for(let t=0,n=e.length;t<n;t++)e[t].updateMatrixWorld()}}}}const le=new i.Sphere,ce=new i.Matrix4,he=new i.Vector3,de=new i.Vector3,ue=new i.Ray,pe=[];function fe(e,t){return e.distance-t.distance}function me(e,t,n){e.traverse((e=>{Object.getPrototypeOf(e).raycast.call(e,t,n)}))}function ge(e,t,n,s){if(n.has(e)){if(me(e.cached.scene,s,pe),pe.length>0){pe.length>1&&pe.sort(fe);const e=pe[0];return pe.length=0,e}return null}const r=[],i=e.children;for(let e=0,n=i.length;e<n;e++){const n=i[e],o=n.cached,a=t.matrixWorld;ce.copy(a);const l=o.sphere;if(l&&(le.copy(l),le.applyMatrix4(ce),!s.ray.intersectsSphere(le)))continue;const c=o.box,h=o.boxTransform;if(c){if(ce.multiply(h).invert(),ue.copy(s.ray),ue.applyMatrix4(ce),!ue.intersectBox(c,he))continue;{let e;de.setFromMatrixScale(ce),e=de.x,Math.abs(Math.max(de.x-de.y,de.x-de.z))>1e-6&&console.warn("ThreeTilesRenderer : Non uniform scale used for tile which may cause issues when raycasting.");let t={distance:1/0,tile:null};r.push(t),t.distance=he.distanceToSquared(ue.origin)*e*e,t.tile=n}}}r.sort(fe);let o=1/0,a=null;for(let e=0,i=r.length;e<i;e++){const i=r[e];if(i.distance>o)break;{const e=i.tile,r=e.cached.scene;let l=null;if(n.has(e)?(me(r,s,pe),pe.length>0&&(pe.length>1&&pe.sort(fe),l=pe[0])):l=ge(e,t,n,s),l){const e=l.distance*l.distance;e<o&&(o=e,a=l),pe.length=0}}}return a}function xe(e,t,n,s,r){const i=e.cached,o=t.matrixWorld;ce.copy(o);const a=i.sphere;if(a&&(le.copy(a),le.applyMatrix4(ce),!s.ray.intersectsSphere(le)))return;const l=i.box,c=i.boxTransform;if(l&&(ce.multiply(c).invert(),ue.copy(s.ray).applyMatrix4(ce),!ue.intersectsBox(l)))return;const h=i.scene;if(n.has(e))return void me(h,s,r);const d=e.children;for(let e=0,i=d.length;e<i;e++)xe(d[e],t,n,s,r)}const ye=Symbol("INITIAL_FRUSTUM_CULLED"),be=new i.Matrix4,we=new i.Matrix4,_e=new i.Vector3,Te=new i.Vector3,ve=new i.Vector3,Se=new i.Vector3,Me=new i.Vector3(1,0,0),Ce=new i.Vector3(0,1,0);function Ae(e,t){e.traverse((e=>{e.frustumCulled=e[ye]&&t}))}class Le extends D{get autoDisableRendererCulling(){return this._autoDisableRendererCulling}set autoDisableRendererCulling(e){this._autoDisableRendererCulling!==e&&(super._autoDisableRendererCulling=e,this.forEachLoadedModel((t=>{Ae(t,!e)})))}constructor(...e){super(...e),this.group=new ae(this),this.cameras=[],this.cameraMap=new Map,this.cameraInfo=[],this.activeTiles=new Set,this.visibleTiles=new Set,this._autoDisableRendererCulling=!0,this.optimizeRaycast=!0,this.onLoadTileSet=null,this.onLoadModel=null,this.onDisposeModel=null,this.onTileVisibilityChange=null;const t=new i.LoadingManager;t.setURLModifier((e=>this.preprocessURL?this.preprocessURL(e):e)),this.manager=t;const n=this;this._overridenRaycast=function(e,t){n.optimizeRaycast||Object.getPrototypeOf(this).raycast.call(this,e,t)}}getBounds(e){if(!this.root)return!1;const t=this.root.cached,n=t.box,s=t.boxTransform;return!!n&&(e.copy(n),e.applyMatrix4(s),!0)}getOrientedBounds(e,t){if(!this.root)return!1;const n=this.root.cached,s=n.box,r=n.boxTransform;return!!s&&(e.copy(s),t.copy(r),!0)}getBoundingSphere(e){if(!this.root)return!1;const t=this.root.cached.sphere;return!!t&&(e.copy(t),!0)}forEachLoadedModel(e){this.traverse((t=>{const n=t.cached.scene;n&&e(n,t)}))}raycast(e,t){if(this.root)if(e.firstHitOnly){const n=ge(this.root,this.group,this.activeTiles,e);n&&t.push(n)}else xe(this.root,this.group,this.activeTiles,e,t)}hasCamera(e){return this.cameraMap.has(e)}setCamera(e){const t=this.cameras,n=this.cameraMap;return!n.has(e)&&(n.set(e,new i.Vector2),t.push(e),!0)}setResolution(e,t,n){const s=this.cameraMap;return!!s.has(e)&&(t instanceof i.Vector2?s.get(e).copy(t):s.get(e).set(t,n),!0)}setResolutionFromRenderer(e,t){const n=this.cameraMap;if(!n.has(e))return!1;const s=n.get(e);return t.getSize(s),s.multiplyScalar(t.getPixelRatio()),!0}deleteCamera(e){const t=this.cameras,n=this.cameraMap;if(n.has(e)){const s=t.indexOf(e);return t.splice(s,1),n.delete(e),!0}return!1}fetchTileSet(e,...t){const n=super.fetchTileSet(e,...t);return n.then((t=>{this.onLoadTileSet&&Promise.resolve().then((()=>{this.onLoadTileSet(t,e)}))})),n}update(){const e=this.group,t=this.cameras,n=this.cameraMap,s=this.cameraInfo;if(0===t.length)return void console.warn("TilesRenderer: no cameras defined. Cannot update 3d tiles.");for(;s.length>t.length;)s.pop();for(;s.length<t.length;)s.push({frustum:new i.Frustum,isOrthographic:!1,sseDenominator:-1,position:new i.Vector3,invScale:-1,pixelSize:0});let r;we.copy(e.matrixWorld).invert(),_e.setFromMatrixScale(we),r=_e.x,Math.abs(Math.max(_e.x-_e.y,_e.x-_e.z))>1e-6&&console.warn("ThreeTilesRenderer : Non uniform scale used for tile which may cause issues when calculating screen space error.");for(let i=0,o=s.length;i<o;i++){const o=t[i],a=s[i],l=a.frustum,c=a.position,h=n.get(o);0!==h.width&&0!==h.height||console.warn("TilesRenderer: resolution for camera error calculation is not set.");const d=o.projectionMatrix.elements;if(a.isOrthographic=1===d[15],a.isOrthographic){const e=2/d[0],t=2/d[5];a.pixelSize=Math.max(t/h.height,e/h.width)}else a.sseDenominator=2/d[5]/h.height;a.invScale=r,be.copy(e.matrixWorld),be.premultiply(o.matrixWorldInverse),be.premultiply(o.projectionMatrix),l.setFromProjectionMatrix(be),c.set(0,0,0),c.applyMatrix4(o.matrixWorld),c.applyMatrix4(we)}super.update()}preprocessNode(e,t,n){super.preprocessNode(e,t,n);const s=new i.Matrix4;if(e.transform){const t=e.transform;for(let e=0;e<16;e++)s.elements[e]=t[e]}else s.identity();t&&s.premultiply(t.cached.transform);const r=(new i.Matrix4).copy(s).invert();let o=null,a=null,l=null;if("box"in e.boundingVolume){const t=e.boundingVolume.box;o=new i.Box3,a=new i.Matrix4,l=new i.Matrix4,Te.set(t[3],t[4],t[5]),ve.set(t[6],t[7],t[8]),Se.set(t[9],t[10],t[11]);const n=Te.length(),r=ve.length(),c=Se.length();Te.normalize(),ve.normalize(),Se.normalize(),0===n&&Te.crossVectors(ve,Se),0===r&&ve.crossVectors(Te,Se),0===c&&Se.crossVectors(Te,ve),a.set(Te.x,ve.x,Se.x,t[0],Te.y,ve.y,Se.y,t[1],Te.z,ve.z,Se.z,t[2],0,0,0,1),a.premultiply(s),l.copy(a).invert(),o.min.set(-n,-r,-c),o.max.set(n,r,c)}let c=null;if("sphere"in e.boundingVolume){const t=e.boundingVolume.sphere;c=new i.Sphere,c.center.set(t[0],t[1],t[2]),c.radius=t[3],c.applyMatrix4(s)}else if("box"in e.boundingVolume){const t=e.boundingVolume.box;c=new i.Sphere,o.getBoundingSphere(c),c.center.set(t[0],t[1],t[2]),c.applyMatrix4(s)}"region"in e.boundingVolume&&console.warn("ThreeTilesRenderer: region bounding volume not supported."),e.cached={loadIndex:0,transform:s,transformInverse:r,active:!1,inFrustum:[],box:o,boxTransform:a,boxTransformInverse:l,sphere:c,region:null,scene:null,geometry:null,material:null}}parseTile(e,t,n){t._loadIndex=t._loadIndex||0,t._loadIndex++;const s=t.content.uri.split(/[\\\/]/g);s.pop();const r=s.join("/"),i=this.fetchOptions,o=this.manager,a=t._loadIndex;let l=null;switch(n){case"b3dm":{const t=new W(o);t.workingPath=r,t.fetchOptions=i,l=t.parse(e).then((e=>e.scene));break}case"pnts":{const t=new Q(o);t.workingPath=r,t.fetchOptions=i,l=t.parse(e).then((e=>e.scene));break}case"i3dm":{const t=new ne(o);t.workingPath=r,t.fetchOptions=i,l=t.parse(e).then((e=>e.scene));break}case"cmpt":{const t=new re(o);t.workingPath=r,t.fetchOptions=i,l=t.parse(e).then((e=>e.scene));break}case"gltf":case"glb":const t=new ie(o);t.workingPath=r,t.fetchOptions=i,l=t.parse(e).then((e=>e.scene));break;default:console.warn(`TilesRenderer: Content type "${n}" not supported.`),l=Promise.resolve(null)}return l.then((e=>{if(t._loadIndex!==a)return;const s=this.rootTileSet.asset&&this.rootTileSet.asset.gltfUpAxis||"y",r=t.cached,i=r.transform;switch(s.toLowerCase()){case"x":be.makeRotationAxis(Ce,-Math.PI/2);break;case"y":be.makeRotationAxis(Me,Math.PI/2);break;case"z":be.identity()}e.updateMatrix(),"pnts"!==n&&e.matrix.multiply(be),e.matrix.premultiply(i),e.matrix.decompose(e.position,e.quaternion,e.scale),e.traverse((e=>{e[ye]=e.frustumCulled})),Ae(e,!this.autoDisableRendererCulling),r.scene=e,e.traverse((e=>{e.raycast=this._overridenRaycast}));const o=[],l=[],c=[];e.traverse((e=>{if(e.geometry&&l.push(e.geometry),e.material){const t=e.material;o.push(e.material);for(const e in t){const n=t[e];n&&n.isTexture&&c.push(n)}}})),r.materials=o,r.geometry=l,r.textures=c,this.onLoadModel&&this.onLoadModel(e,t)}))}disposeTile(e){const t=e.cached;if(t.scene){const n=t.materials,s=t.geometry,r=t.textures;for(let e=0,t=s.length;e<t;e++)s[e].dispose();for(let e=0,t=n.length;e<t;e++)n[e].dispose();for(let e=0,t=r.length;e<t;e++){r[e].dispose()}this.onDisposeModel&&this.onDisposeModel(t.scene,e),t.scene=null,t.materials=null,t.textures=null,t.geometry=null}e._loadIndex++}setTileVisible(e,t){const n=e.cached.scene,s=this.visibleTiles,r=this.group;t?(r.add(n),s.add(e),n.updateMatrixWorld(!0)):(r.remove(n),s.delete(e)),this.onTileVisibilityChange&&this.onTileVisibilityChange(n,e,t)}setTileActive(e,t){const n=this.activeTiles;t?n.add(e):n.delete(e)}calculateError(e){const t=e.cached,n=t.inFrustum,s=this.cameras,r=this.cameraInfo,i=e.boundingVolume;if("box"in i||"sphere"in i){const i=t.sphere,o=t.box,a=t.boxTransformInverse,l=t.transformInverse,c=o&&a;let h=-1/0,d=1/0;for(let t=0,u=s.length;t<u;t++){if(!n[t])continue;const s=r[t],u=s.invScale;let p;if(s.isOrthographic){const t=s.pixelSize;p=e.geometricError/(t*u)}else{let t;_e.copy(s.position),c?(_e.applyMatrix4(a),t=o.distanceToPoint(_e)):(_e.applyMatrix4(l),t=Math.max(i.distanceToPoint(_e),0));const n=t*u,r=s.sseDenominator;p=e.geometricError/(n*r),d=Math.min(d,n)}h=Math.max(h,p)}e.__distanceFromCamera=d,e.__error=h}else"region"in i&&console.warn("ThreeTilesRenderer : Region bounds not supported.")}tileInView(e){const t=e.cached,n=t.sphere,s=t.inFrustum;if(n){const e=this.cameraInfo;let t=!1;for(let r=0,i=e.length;r<i;r++){e[r].frustum.intersectsSphere(n)?(t=!0,s[r]=!0):s[r]=!1}return t}return!0}}var Be=n(61728);class Pe{constructor(){this.caches=new Map}registerPlugin(e,t){this.caches.has(e)||this.caches.set(e,new Map);const n=this.caches.get(e);e.pluginCallbacks.unshift((e=>new Ue(e,t,n)))}unregisterLoader(e){this.caches.delete(e)}unregisterAllLoaders(){this.caches.clear()}}class Ue{constructor(e,t,n){this.parser=e,this.modelKey=t,this.textureCache=n,this.name="CrossModelTextureCache"}key(e){return`${e} @ ${this.modelKey}`}loadTexture(e){var t;const n=this.textureCache,s=this.parser,r=s.json,i=r.textures[e];let o=i.source;Object.keys(i.extensions).forEach((e=>o=o||i.extensions[e].source));const a=null===(t=r.images[o])||void 0===t?void 0:t.uri;if(void 0===a)return null;const l=n.get(this.key(a));if(l)return l;let c=s._invokeOne((t=>t===this?null:t.loadTexture&&t.loadTexture(e)));c||(c=s.loadTexture(e));const h=c.then((e=>{const t=()=>{n.delete(this.key(a)),null==e||e.removeEventListener("dispose",t)};return null==e||e.addEventListener("dispose",t),e}));return n.set(this.key(a),h),h}}var ke=n(79545),Re=n(99276);class Ve{constructor(e){this.parser=e,this.name="MTTR_three_mesh_bvh"}async loadMesh(e){const t=async(t,n)=>{var s,r;const i=this.parser.json.meshes[e].primitives[n];if(null===(s=i.extensions)||void 0===s?void 0:s.MTTR_three_mesh_bvh){const e=null===(r=i.extensions)||void 0===r?void 0:r.MTTR_three_mesh_bvh,n={roots:(await Promise.all(e.roots.map((e=>this.parser.loadAccessor(e))))).map((e=>{const t=e.array;return t.byteLength!==t.buffer.byteLength?t.slice().buffer:t.buffer})),index:new Uint8Array(0)};t.geometry.boundsTree=ke.G.deserialize(n,t.geometry,{setIndex:!1})}},n=[],s=await this.loadMeshInternal(e);if(s)if("Group"===s.type){const e=s;n.push(...e.children.map(((e,n)=>t(e,n))))}else"Mesh"===s.type&&n.push(t(s,0));return await Promise.all(n),s}async loadMeshInternal(e){const t=this.parser,n=t,r=this.parser.json.meshes[e],o=r.primitives,a=[];for(let e=0,s=o.length;e<s;e++){const s=void 0===o[e].material?t.createDefaultMaterial(n.cache):t.getDependency("material",o[e].material);a.push(s)}return a.push(t.loadGeometries(o)),Promise.all(a).then((function(n){const a=n.slice(0,n.length-1),l=n[n.length-1],c=[];for(let n=0,i=l.length;n<i;n++){const i=l[n],h=o[n];let d;const u=a[n];if(h.mode!==Oe.TRIANGLES&&void 0!==h.mode)throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+h.mode);d=new Re.B(0,0,s.H.DEFAULT),d.geometry=i,d.material=u,d.name=t.createUniqueName(r.name||"mesh_"+e),Ee(d,r),t.assignFinalMaterial(d),c.push(d)}if(1===c.length)return c[0];const h=new i.Group;for(let e=0,t=c.length;e<t;e++)h.add(c[e]);return h}))}}const Oe={FLOAT:5126,FLOAT_MAT3:35675,FLOAT_MAT4:35676,FLOAT_VEC2:35664,FLOAT_VEC3:35665,FLOAT_VEC4:35666,LINEAR:9729,REPEAT:10497,SAMPLER_2D:35678,POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6,UNSIGNED_BYTE:5121,UNSIGNED_SHORT:5123};function Ee(e,t){void 0!==t.extras&&"object"==typeof t.extras&&Object.assign(e.userData,t.extras)}var Fe=n(71916),De=n(97084);class Ie extends Fe.KTX2Loader{constructor(e,t,n){super(n),this.urlSigner=e,this.api=t,this.taskCache=new WeakMap}load(e,t,n,s){const r=new i.CompressedTexture([],0,0,i.RGB_ETC2_Format);return this.urlSigner(e).then((async e=>{const s=await this.api.get(e,{onProgress:n,responseType:"arraybuffer",priority:De.QK.MEDIUM});let i=this.taskCache.get(s);if(!i){i={promise:this._createTexture(s)},this.taskCache.set(s,i)}const o=await i.promise;r.copy(o),r.needsUpdate=!0,t(r)})).catch(s),r}preload(){this.init()}}let ze;const Ne=/\gltf$/,He=/\glb$/;var Ge,je=n(70497);class We extends M{constructor(e,t,n,s){super(),this.urlSigner=e,this.api=t,this.onProgress=s,this.priorityCallback=n}add(e,t){return super.add(e,(async e=>{var n,s,r;if(null===(n=null==e?void 0:e.content)||void 0===n?void 0:n.uri){const n=e.content.uri;try{const i=null===(s=this.onProgress)||void 0===s?void 0:s.bind(this,e);if(e.content.uri=await this.urlSigner(n),(null===(r=e.extras)||void 0===r?void 0:r.level)===je.X.Min)return t(e).then((e=>i?function(e,t){if(e.ok&&e.body){const n=e.body.getReader(),s=e.headers.get("Content-Length");let r=s?+s:0,i=0!==r,o=0;const a=new ReadableStream({async start(e){for(;;){const{done:s,value:a}=await n.read();if(a&&(o+=a.byteLength,e.enqueue(a)),s&&(r=o,i=!0),null==t||t(new ProgressEvent("progress",{lengthComputable:i,loaded:o,total:r})),s){e.close();break}}}});e=new Response(a)}return e}(e,i):e));{const n=window.fetch;try{return window.fetch=async(e,t)=>{const n=await this.api.get(e,{responseType:"blob",priority:De.QK.MEDIUM,onProgress:i,signal:null==t?void 0:t.signal});return new Response(n)},t(e)}finally{window.fetch=n}}}finally{e.content.uri=n}}}))}}class $e extends M{constructor(e){super(),this.settings=e,this.prioritizeBy=Ge.FRUSTUM_ERROR_THRESH,this.priorityCallback=(e,t)=>this.prioritizeBy===Ge.FRUSTUM_ERROR_THRESH?this.sortBySelectors(e,t,[e=>Number(e.__inFrustum),e=>Number(e.__error<=this.settings.errorTarget),e=>e.__error,e=>e.__distanceFromCamera]):this.defaultPriorityCallback(e,t)}sortBySelectors(e,t,n){for(const s of n){const n=this.compareTile(e,t,s);if(null!==n)return n}return 0}compareTile(e,t,n){const s=n(e),r=n(t);return s===r?null:s>r?1:-1}defaultPriorityCallback(e,t){return e.__depth!==t.__depth?e.__depth>t.__depth?-1:1:e.__inFrustum!==t.__inFrustum?e.__inFrustum?1:-1:e.__used!==t.__used?e.__used?1:-1:e.__error!==t.__error?e.__error>t.__error?1:-1:e.__distanceFromCamera!==t.__distanceFromCamera?e.__distanceFromCamera>t.__distanceFromCamera?-1:1:0}}!function(e){e.DEFAULT="DEFAULT",e.FRUSTUM_ERROR_THRESH="FRUSTUM_ERROR_THRESH"}(Ge||(Ge={}));var Qe=n(75078),qe=n(39994);const Xe=3;class Je{constructor(e,t,n,s,r,i,o,a){this.container=e,this.threeRenderer=t,this.chunkFactory=n,this.tilesetInfo=s,this.commandBinder=r,this.api=i,this.gltfConfig=o,this.settings=a,this.name="MttrTileLoader",this.log=new b.Ay("3d-tiles"),this.loadStats={startTimes:{start:0,tileset:0,lod0:0},timings:{tileset:"",lod0:""}},this.lodDeferreds=[],this.tileProgress=new WeakMap,this.onChunksLoaded=new Set,this.onChunksUnloaded=new Set,this.tileSetLoaded=!1,this.minimalLoaded=!1,this.minimalTileCount=0,this.signUrl=async e=>{if(e.startsWith("blob"))return e;return(await this.tilesetInfo.urlTemplate.get()).replace(this.settings.urlTemplateToken,e)},this.onTileGltfDownloadProgress=(e,t)=>{this.tileProgress.set(e,t.lengthComputable?.5*t.loaded/t.total:0),this.checkLoadStatus()},this.checkLoadStatus=(()=>{const e=[];let t=!1,n=!1;return(0,w.n)((()=>{t&&n||!this.tileSetLoaded||(0===e.length&&(e.push([],[]),this.tilesRenderer.traverse(((t,n,s)=>{var r;const i=null===(r=t.extras)||void 0===r?void 0:r.level;return 0!==i&&1!==i||e[i].push(t),!1}),null)),t||(t=this.notifyIfFullyLoaded(0,e,!0),t&&(this.tilesRenderer.update(),this.log.debug("LOD0 fully downloaded, allow showing more lods"),this.minimalLoaded=!0,this.minimalTileCount=e[0].length,this.loadStats.timings.lod0=(performance.now()-this.loadStats.startTimes.lod0).toFixed(1)+"ms")),n||(n=this.notifyIfFullyLoaded(1,e,!1),n&&(e.length=0)))}),16)})()}async init(){this.loadStats.startTimes.start=performance.now();const e=await this.signUrl(this.tilesetInfo.rootFilename);this.tilesRenderer=new Le(e),this.tilesRenderer.manager=new i.LoadingManager;const t=function(e,t,n,s,r,i){const o=new Be.DRACOLoader(t);o.setDecoderPath(`${r.dracoDecoderPath}`),o.preload();const a=new j.GLTFLoader(t);a.setDRACOLoader(o),a.register((e=>new Ve(e))),ze||(ze=new Pe),ze.registerPlugin(a,i);const l=new Ie(n,s,t);return l.setTranscoderPath(r.basisTranscoderPath),l.detectSupport(e),l.preload(),a.setKTX2Loader(l),t.removeHandler(Ne),t.addHandler(Ne,a),t.removeHandler(He),t.addHandler(He,a),a}(this.threeRenderer,this.tilesRenderer.manager,this.signUrl,this.api,this.gltfConfig,e);this.configureTilesRenderer(this.tilesRenderer,t)}setCamera(e,t,n){this.tilesRenderer.setCamera(e),this.tilesRenderer.setResolution(e,t,n)}hasCamera(e){return this.tilesRenderer.hasCamera(e)}deleteCamera(e){return this.tilesRenderer.deleteCamera(e)}notifyOnChunksLoaded(e){return(0,x.Sh)((()=>this.onChunksLoaded.add(e)),(()=>this.onChunksLoaded.delete(e)),!0)}notifyOnChunksUnloaded(e){return(0,x.Sh)((()=>this.onChunksUnloaded.add(e)),(()=>this.onChunksUnloaded.delete(e)),!0)}notifyOnLodProgress(e,t){this.getLodDeferred(e).progress(t)}awaitLod(e){return this.getLodDeferred(e).nativePromise()}getLodDeferred(e){return this.lodDeferreds[e]||(this.lodDeferreds[e]=new y.i)}update(){const{minimalLoaded:e,tilesRenderer:t}=this;e?(t.displayActiveTiles=this.settings.displayActiveTiles,t.loadSiblings=this.settings.loadSiblings,t.stopAtEmptyTiles=this.settings.stopAtEmptyTiles,t.autoDisableRendererCulling=this.settings.autoDisableRendererCulling,t.downloadQueue.maxJobs=this.settings.downloadQueueConcurrency,t.parseQueue.maxJobs=this.settings.parseQueueConcurrency):(t.loadSiblings=!0,t.downloadQueue.maxJobs=1/0,t.parseQueue.maxJobs=1/0),t.optimizeRaycast=this.settings.optimizeRaycast,t.errorTarget=this.settings.errorTarget,t.lruCache.maxSize=e?Math.max(this.settings.lruMaxTiles,this.minimalTileCount):1/0,t.update(),t.lruCache.minSize=this.settings.lruMinExtraTiles+t.lruCache.usedSet.size,t.lruCache.unloadPercent=this.settings.lruUnloadPercent}getDownloadParseStatus(){return this.tilesRenderer.stats}configureTilesRenderer(e,t){const n=e.calculateError.bind(e);e.calculateError=e=>{n(e),this.adjustScreenSpaceError&&(e.__error=this.adjustScreenSpaceError(e.__error,e))},e.errorTarget=this.settings.errorTarget,e.loadSiblings=this.settings.loadSiblings,e.stopAtEmptyTiles=this.settings.stopAtEmptyTiles,e.displayActiveTiles=this.settings.displayActiveTiles;const s=e.preprocessNode.bind(e);e.preprocessNode=function(e,t,n){return s(e,t,"")},this.configurePriorityQueues(),this.container.add(e.group);const r=(new i.Quaternion).setFromAxisAngle(new i.Vector3(-1,0,0),i.MathUtils.degToRad(90));this.container.quaternion.copy(r),this.container.updateMatrixWorld(!0),e.onLoadTileSet=this.onLoadTileset.bind(this),e.onLoadModel=this.onLoadModel.bind(this),e.onDisposeModel=this.onDisposeModel.bind(this);const o=e.setTileActive.bind(e);e.setTileActive=(e,t)=>{o(e,t),this.onTileActiveChange&&this.onTileActiveChange(e,t)};const a=e.setTileVisible.bind(e);e.setTileVisible=(e,t)=>{a(e,t),this.onTileVisibleChange&&this.onTileVisibleChange(e,t)};const l=e.tileInView.bind(e);e.tileInView=e=>{let t=l(e);return this.adjustTileInView&&(t=this.adjustTileInView(t,e)),t}}configurePriorityQueues(){const{tilesRenderer:e}=this;e.downloadQueue=new We(this.signUrl,this.api,e.downloadQueue.priorityCallback,this.onTileGltfDownloadProgress),e.parseQueue=new $e(this.settings);const t=e=>{this.commandBinder.issueCommand(new _.m("mesh/tiled/priorityQueue",e,100))};e.parseQueue.schedulingCallback=t,e.downloadQueue.schedulingCallback=t}async onLoadModel(e,t){const n=function(e,t,n){var s;const r=[],i=(null===(s=t.extras)||void 0===s?void 0:s.id)||""+e.id;return e.name=i,e.traverse((s=>{var o,a;if(s.matrixAutoUpdate=!1,s.updateMatrix(),s instanceof Re.B){const l=new Qe.$(s);e.add(l);const{group:c,subgroup:h,chunkIndex:d}=(0,qe.g8)(`${i}-${s.name}`),u=s.material,p=u.map;let f=null!==(o=null==p?void 0:p.name)&&void 0!==o?o:u.name;f=f.replace(".jpg","");const m=n(c,h,s.geometry,f);m.textureLODInfo=function(e,t){if(t&&(null==t?void 0:t.maxTextureSize)&&(null==t?void 0:t.texelSize)&&(null==t?void 0:t.textureScale)&&t.textureScale>0){const n=t.textureScale;return{name:e,maxTexelSize:.001*t.texelSize,maxTextureSize:t.maxTextureSize,minTexelSize:1/n*t.texelSize*.001,minTextureSize:n*t.maxTextureSize,minScale:n}}return null}(f,t.extras)||void 0,m.lod=(null===(a=t.extras)||void 0===a?void 0:a.level)||0,m.chunkIndex=d,m.notifyOnMaterialUpdated((e=>{s.material=e}));const g={};g.map=p,s.buildWithSingleChunk(m),s.material=m.setMaterialsUniform(g),m.name=s.name,m.embeddedTexture=g.map,r.push(m)}})),e.matrixWorld.copy(e.matrix),e.matrixWorld.premultiply(l),e.children.forEach((e=>e.updateMatrixWorld(!0))),r}(e,t,this.chunkFactory);for(const e of n)this.container.addChunk(e);for(const e of this.onChunksLoaded.values())e(n,t);this.onModelLoaded&&this.onModelLoaded(e,t),this.tileProgress.set(t,1),await new Promise((e=>setTimeout(e,0))),this.checkLoadStatus()}onDisposeModel(e,t){e.traverse((e=>{if((0,p.PO)(e)){const n=e.chunks;if(!n)return void this.log.error("Missing chunks from RoomMesh");for(const e of n)this.container.removeChunk(e);for(const e of this.onChunksUnloaded.values())e(n,t)}})),this.onModelUnloaded&&this.onModelUnloaded(e,t),e.traverse((e=>{(0,p.PO)(e)&&e.reset()}))}onLoadTileset(e,t){var n;const s=!this.tileSetLoaded;let r="";s&&(r=(performance.now()-this.loadStats.startTimes.start).toFixed(1),this.loadStats.timings.tileset=r+"ms");const i=null===(n=t.match(/[^/]*\.json/))||void 0===n?void 0:n[0];this.log.debug(`Tileset ${i} load${s?`: ${r}ms`:""}`,e),s&&(this.loadStats.startTimes.lod0=performance.now()),this.tileSetLoaded=!0,this.onTilesetLoaded&&this.onTilesetLoaded(e,t),this.tilesRenderer.update()}notifyIfFullyLoaded(e,t,n){if(!t[e])return!1;const s=t[e],r=s.filter((e=>e.__loadingState!==Xe)),i=this.getLodDeferred(e);return n&&i.notify(s.reduce(((e,t)=>e+(this.tileProgress.get(t)||0)/s.length),0)),0===r.length&&i.resolve(),0===r.length}}var Ze=n(47299),Ke=n(80112);class Ye extends g.o{constructor(e,t=s.H.ALL,n){super(),this.uuid=e,this.renderLayer=t,this.chunkSharedState=n,this.boundingBox=new i.Box3,this.size=new i.Vector3,this.center=new i.Vector3,this.tilesByChunkId=new Map,this.bindings=[],this.roomMeshesByTile=new Map,this.activeRoomMeshes=new Set,this.visibleRoomMeshes=new Set,this.activeTiles=new Set,this.tileActiveDescendantCounts=new WeakMap,this.isActiveRoomMeshFilter=e=>this.activeRoomMeshes.has(e),this.isActiveRoomMeshSnapFilter=e=>{var t,n,s;const r=null===(t=e.meta)||void 0===t?void 0:t.tile;if(r){const{snappingMaxLOD:e}=this.settings,t=null!==(s=null===(n=r.extras)||void 0===n?void 0:n.level)&&void 0!==s?s:1/0;if(t===e&&(this.tileActiveDescendantCounts.get(r)||0)>0||t<=e&&this.activeTiles.has(r))return!0}return!1},this.settings=Object.assign({},Ke.W),this.maxLOD=this.settings.maxLOD,this.layers.mask=t.mask,this.overriddenIsTileInView=this.overriddenIsTileInView.bind(this),this.flipDownload=!1,this.flipUpload=!1}dispose(){super.dispose(),this.bindings.forEach((e=>e.cancel())),this.bindings=[]}async load(e,t,n,s,i,o,a,c,h,d){this.renderer=t,this.cameraData=s,o.root=this,this.maxLOD=this.settings.maxLOD=i.maxLOD,this.tileLoader=new Je(this,t.threeRenderer,a,i,e.commandBinder,h,d,this.settings),await this.tileLoader.init(),this.tileLoader.setCamera(n,s.width,s.height),this.bindings.push(e.subscribe(r.h,(e=>{this.tileLoader.setCamera(n,e.width,e.height)}))),this.tileLoader.onModelLoaded=(e,t)=>{let n=this.roomMeshesByTile.get(t);n||(n=[],this.roomMeshesByTile.set(t,n)),e.traverse((e=>{e.layers.mask=this.renderLayer.mask,(0,p.PO)(e)&&(o.rooms.add(e),n.push(e),this.inputIni&&this.registerMeshForCollision(this.inputIni,e,t))})),o.commit()},this.tileLoader.onModelUnloaded=(e,t)=>{e.traverse((e=>{e instanceof Re.B&&(o.rooms.delete(e),this.inputIni&&this.unregisterMeshFromCollision(this.inputIni,e))})),o.commit(),this.tileLoader.onTileActiveChange(t,!1),this.tileLoader.onTileVisibleChange(t,!1),this.roomMeshesByTile.delete(t)},this.tileLoader.onTileActiveChange=(e,t)=>{var n;const s=t?"add":"delete";null===(n=this.roomMeshesByTile.get(e))||void 0===n||n.forEach((e=>{this.activeRoomMeshes[s](e)})),this.activeTiles[s](e);for(let n=e.parent;n;n=n.parent){const e=this.tileActiveDescendantCounts.get(n)||0;this.tileActiveDescendantCounts.set(n,e+(t?1:-1))}},this.tileLoader.onTileVisibleChange=(e,t)=>{var n;null===(n=this.roomMeshesByTile.get(e))||void 0===n||n.forEach((e=>{this.visibleRoomMeshes[t?"add":"delete"](e)}))},this.initTileLodAdjustments(this.tileLoader,c),this.tileLoader.notifyOnLodProgress(0,(t=>{e.broadcast(new m.EX(t,1))})),this.tileLoader.notifyOnChunksLoaded(((e,n)=>{var s;0===(null===(s=n.extras)||void 0===s?void 0:s.level)&&e.forEach((e=>{t.threeRenderer.initTexture(e.embeddedTexture)}))})),this.tileLoader.update(),this._detail="minimal",await this.tileLoader.awaitLod(this.settings.initialMaxLOD),this._detail="default",this.tileLoader.tilesRenderer.getBounds(this.boundingBox),this.boundingBox.getSize(this.size).applyMatrix4(l),this.boundingBox.getCenter(this.center).applyMatrix4(l);const u=this.size.clone().multiplyScalar(.5).length(),{smallMeshThreshold:f,smallMeshErrorMultiplier:g}=this.settings;u<f&&(this.settings.errorTarget=Math.min(this.settings.errorTarget,u*g))}initTextureLoader(e,t){return e.limitMemoryUsage=this.settings.limitMemoryUsage,e.setModel(this,this._chunks,t),this.bindings.push(this.tileLoader.notifyOnChunksLoaded((t=>{e.addChunkSlots(this,t);for(const e of this.onChunksLoaded.values())e(t)})),this.tileLoader.notifyOnChunksUnloaded((t=>{e.removeChunks(t)}))),e.allowTextureDownload=()=>{const{downloading:e,parsing:t}=this.tileLoader.getDownloadParseStatus();return 0===e&&0===t},Promise.resolve()}initTileLodAdjustments(e,t){e.adjustTileInView=this.overriddenIsTileInView;const n=this.tilesByChunkId,s=new Map;let r=0;this.bindings.push(e.notifyOnChunksLoaded(((e,t)=>{for(const s of e)n.set(s.id,t)})),t.notifyOnNewSighting(((e,t)=>{r++;const i=n.get(e.id);if(i){for(let e=i.parent;e;e=e.parent)s.set(e,r);c(i,(e=>!(e!==i&&!h(t.point,e))&&(s.set(e,r),!0)))}})),this.tileLoader.notifyOnChunksUnloaded((e=>{for(const t of e)n.delete(t.id),t.dispose()}))),e.adjustScreenSpaceError=(e,t)=>{var n,i;if(1!==this.settings.errorMultiplierRaycastOcclusion){(null!==(n=s.get(t))&&void 0!==n?n:-1/0)<r-Ze.xT.sightingMaxAge&&(e*=this.settings.errorMultiplierRaycastOcclusion)}if(1!==this.settings.errorMultiplierHiddenFloors){(null===(i=this.roomMeshesByTile.get(t))||void 0===i?void 0:i.some((e=>e.chunks.some((e=>e.getOpacity()>Ze.u7.FADE_TILE_VISIBLE_THRESHOLD)))))||(e*=this.settings.errorMultiplierHiddenFloors)}return u(t)<this.settings.minLOD&&(e=Math.max(e,this.settings.errorTarget+1e-10)),e}}registerCollision(e){this.inputIni=e,this.tileLoader.tilesRenderer.forEachLoadedModel(((t,n)=>{t.traverse((t=>{(0,p.PO)(t)&&this.registerMeshForCollision(e,t,n)}))}))}unregisterCollision(e){this.tileLoader.tilesRenderer.forEachLoadedModel(((t,n)=>{t.traverse((t=>{(0,p.PO)(t)&&this.unregisterMeshFromCollision(e,t)}))}))}addChunk(e){this._chunks.push(e)}removeChunk(e){const t=this._chunks.indexOf(e);this._chunks.splice(t,1)}onUpdate(){this.settings.disableTileUpdates||(this.tileLoader.tilesRenderer.setResolution(this.renderer.getCamera(),this.cameraData.width,this.cameraData.height),this.tileLoader.update(),this.checkDispose()),this.downgradeIfMemoryConstrained()}setTextureQuality(e,t,n){e.setQuality(f.M.LOW,n)}get visibleChunks(){const e=this.visibleRoomMeshes;return{*[Symbol.iterator](){for(const t of e)for(const e of t.chunks)yield e}}}registerMeshForCollision(e,t,n){e.registerMesh(t,this.addToOctree,this.isActiveRoomMeshFilter),t.chunks[0].lod<=this.settings.snappingMaxLOD&&e.registerSnappingMeshGeometry(t.name,t.geometry,{tile:n,meshGroup:t.meshGroup},this.isActiveRoomMeshSnapFilter)}unregisterMeshFromCollision(e,t){e.unregisterMesh(t),e.unregisterSnappingMeshGeometry(t.name)}overriddenIsTileInView(e,t){const n=u(t.parent);if("minimal"===this._detail&&-1===n)return!0;let s=this.settings.nonMeshMaxLOD;return"max"===this._detail&&(s=this.settings.maxLOD),"minimal"===this._detail&&(s=this.settings.initialMaxLOD),!(n>=s)&&e}overrideMaxDetail(e){if(e!==this._detail)switch(this._detail=e,this._detail){case"minimal":this.setMaxLOD(0);break;case"max":this.setMaxLOD(null);break;default:const e=this.size.length()/2<this.settings.smallMeshThreshold;this.setMaxLOD(e?this.settings.maxLOD:this.settings.nonMeshMaxLOD)}}setMaxLOD(e){e=null!=e?e:this.maxLOD,this.settings.maxLOD=e}downgradeIfMemoryConstrained(){this.renderer.estimatedGPUMemoryAllocated()>2**20*(this.settings.limitMemoryUsage?this.settings.allocatedMegsBeforeLimitingLod:1/0)&&this.settings.maxLOD>0&&this.setMaxLOD(this.settings.maxLOD-1)}checkDispose(){if(this.settings.disposeModel){const e=this.tileLoader.tilesRenderer,t=e;for(const e of t.cameras)t.deleteCamera(e);const n=.001,s=new i.OrthographicCamera(-n,n,n,-n,n,2*n);s.position.set(0,-1e4,0),s.rotation.setFromVector3(new i.Vector3(0,-1,0)),s.updateMatrix(),s.updateMatrixWorld(),this.tileLoader.setCamera(s,100,100),e.lruCache.minSize=0,e.lruCache.unloadPercent=1,e.lruCache.markAllUnused(),e.update(),e.dispose(),this.chunkSharedState.dispose(),this.settings.disableTileUpdates=!0}}}},80112:(e,t,n)=>{n.d(t,{W:()=>o});var s=n(64491),r=n(75778),i=n(70497);const o={urlTemplateToken:"<file>",initialMaxLOD:i.X.Min,nonMeshMaxLOD:i.X.Standard,maxLOD:i.X.High,minLOD:i.X.Min,loadSiblings:!0,displayActiveTiles:!1,autoDisableRendererCulling:!0,optimizeRaycast:!1,stopAtEmptyTiles:!1,disableTileUpdates:!1,disposeModel:!1,limitMemoryUsage:(0,s.Fr)(),allocatedMegsBeforeLimitingLod:350,lruMinExtraTiles:(0,s.Fr)()?0:100,lruMaxTiles:800,lruUnloadPercent:.05,downloadQueueConcurrency:8,parseQueueConcurrency:10,snappingMaxLOD:i.X.Standard,errorTarget:Number((0,r.P3)("errorTarget",(0,s.Fr)()?6:4)),errorMultiplierHiddenFloors:.01,errorMultiplierRaycastOcclusion:.1,smallMeshThreshold:Number((0,r.P3)("smallMeshThreshold",40)),smallMeshErrorMultiplier:Number((0,r.P3)("smallMeshErrorMultiplier",.1))}},14971:(e,t,n)=>{n.d(t,{Jn:()=>c,rt:()=>l});var s=n(68909);const r=n(47299).Ay.sightingMaxAge,i=new s.Color;let o,a=-1;const l=(e,t,n)=>{o||(o=new s.InstancedMesh(new s.SphereGeometry(.005,8,4),new s.MeshBasicMaterial,r),o.frustumCulled=!1,h(o));const l=new s.Matrix4;return({point:s,distance:c})=>{const h=c/n.fovDistanceScale();l.makeScale(h,h,h).setPosition(s),o.setMatrixAt(++a%r,l),o.instanceMatrix.needsUpdate=!0;for(let t=r;t--;)o.setColorAt((a-t+r)%r,i.setHex(e).multiplyScalar(1-t/r));o.instanceColor&&(o.instanceColor.needsUpdate=!0),o.parent||t.scene.add(o)}},c=()=>{var e;o&&(null===(e=o.parent)||void 0===e||e.remove(o),h(o))};function h(e){const t=(new s.Matrix4).makeScale(0,0,0);for(let n=0;n<r;n++)e.setMatrixAt(n,t)}new s.Vector4(1,0,0,1),new s.Vector4(0,1,0,1),new s.Vector4(0,0,1,1),new s.Vector4(1,1,0,1),new s.Vector4(1,0,1,1),new s.Vector4(1,1,1,1),new s.Vector4(0,1,1,1),new s.Vector4(0,0,0,1)},39994:(e,t,n)=>{n.d(t,{QN:()=>o,g8:()=>r,tn:()=>i,yL:()=>a});var s=n(68909);function r(e){const t=e.match(/group([0-9]+)/),n=e.match(/sub([0-9]+)/),s=e.match(/type([0-9]+)/),r=e.match(/mirror([0-9]+)/),i=e.match(/window([0-9]+)/),o=e.match(/chunk([0-9]+)/),a=e.match(/_chunk([0-9]+)/),l=s?parseInt(s[1],10):r&&!isNaN(parseInt(r[1],10))?100:i&&!isNaN(parseInt(i[1],10))?101:0;return{group:t?parseInt(t[1],10):0,subgroup:n?parseInt(n[1],10):0,chunkIndex:o?parseInt(o[1],10):0,nodeIndex:a?parseInt(a[1],10):0,type:l}}function i(e,t=!1){let n=e.getAttribute("barycentric");if(n)return n;const r=(e.getIndex()||e.getAttribute("position")).count/3,i=[];for(let e=0;e<r;e++){const n=t?1:0;e%2==0?i.push(0,0,1,0,1,0,1,0,n):i.push(0,1,0,0,0,1,1,0,n)}const o=new Float32Array(i);return n=new s.BufferAttribute(o,3),e.setAttribute("barycentric",n),n}function o(e=16777215*Math.random(),t=1){const n=function(e,t,n,s=1){const r=document.createElement("canvas");r.width=t,r.height=n;const i=r.getContext("2d");return i&&(i.fillStyle=`rgba(${255*e.r|0},${255*e.g|0},${255*e.b|0}, ${255*s|0})`,i.fillRect(0,0,t,n)),r}((new s.Color).setHex(e),1,1,t),r=new s.CubeTexture([n,n,n,n,n,n]);return r.format=s.RGBAFormat,r.needsUpdate=!0,r}const a=(()=>{const e=new s.Vector3,t=new s.Vector3,n=new s.Vector3,r=new s.Vector3,i=new s.Vector3,o=new s.Vector3;return a=>{const l=new s.Vector3,c=a.index,h=a.getAttribute("position");if(null!=h&&null!=c){let s=0;for(let a=0,d=c.count;a<d;a+=3){const d=c.getX(a+0),u=c.getX(a+1),p=c.getX(a+2);e.fromBufferAttribute(h,d),t.fromBufferAttribute(h,u),n.fromBufferAttribute(h,p),r.subVectors(n,t),i.subVectors(e,t),r.cross(i);const f=r.length()/2;f>0&&(s+=f,o.set(0,0,0).add(e).add(t).add(n).multiplyScalar(1/3*f),l.add(o))}s>0?l.multiplyScalar(1/s):a.boundingBox&&a.boundingBox.getCenter(l)}return l}})()},65936:(e,t,n)=>{n.d(t,{m:()=>r});var s=n(55141);class r extends s.u{constructor(e,t,n){super();const s=function*(){return t()}();this.payload={type:e,func:s,maxDelay:n,steps:1}}}r.id="SCHEDULE_TASK_COMMAND"},84440:(e,t,n)=>{n.d(t,{Mq:()=>a,Zd:()=>o,_o:()=>l});var s=n(68909);const r=()=>Math.random(),i={},o=(e,t=r())=>(i[t]||(i[t]=new s.Vector4(r(),r(),r(),e)),i[t]),a=()=>new s.Color(r(),r(),r()),l=e=>e instanceof Object&&"r"in e&&"g"in e&&"b"in e},30443:(e,t,n)=>{n.d(t,{U7:()=>c,UX:()=>l,Wi:()=>d,h0:()=>i,jF:()=>u,nD:()=>p});var s=n(68909),r=n(81662);function i(e){if(0===e.length)throw Error("Can't merge empty list of geometries");if(1===e.length)return e[0];let t=0,n=0,r=0,i=0;const a=new s.Box3;for(const s of e)s.index&&(t+=s.index.count,n+=s.getAttribute("position").count,s.getAttribute("uv")&&(r+=s.getAttribute("uv").count),s.boundingBox&&(a.union(s.boundingBox),i++));const c=new s.BufferGeometry;i!==e.length||a.isEmpty()?c.computeBoundingBox():c.boundingBox=a,a.copy(l(c)),c.boundingSphere=a.getBoundingSphere(new s.Sphere);const h=o(new Float32Array(3*n),"position",e);c.setAttribute("position",new s.BufferAttribute(h,3));const d=function(e,t){let n=0,s=0;for(const r of t){const t=r.index;for(let r=0;r<t.array.length;r++)e[n+r]=t.array[r]+s;n+=t.array.length,s+=r.getAttribute("position").count}return e}(new Uint32Array(t),e);if(c.setIndex(new s.BufferAttribute(d,1)),r){const t=o(new Float32Array(2*r),"uv",e);c.setAttribute("uv",new s.BufferAttribute(t,2))}return c}function o(e,t,n){let s=0;for(const r of n){const n=r.getAttribute(t);e.set(n.array,s),s+=n.array.length}return e}const a=new s.Box3(r.B1.ZERO,r.B1.UNIT);function l(e){return e.boundingBox||e.computeBoundingBox(),e.boundingBox||a}function c(e,t){let n=1/0;const r=t.clone(),i=new s.Vector3,o=new s.Vector3(1/0,1/0,1/0);let a=-1;const l=new s.Triangle;return function(e,t){var n;const s=null===(n=e.index)||void 0===n?void 0:n.array,r=e.getAttribute("position");if(!r)return;const i=e.groups.length>0?e.groups:[{start:0,count:s?s.length:r.count,materialIndex:0}];let o=0;for(const e of i)for(let n=e.start;n<e.start+e.count;n+=3){let i=n,a=n+1,l=n+2;s&&(i=s[i],a=s[a],l=s[l]),t(r.getX(i),r.getY(i),r.getZ(i),r.getX(a),r.getY(a),r.getZ(a),r.getX(l),r.getY(l),r.getZ(l),o++,e.materialIndex||0)}}(e,((e,t,s,c,h,d,u,p,f,m)=>{l.a.set(e,t,s),l.b.set(c,h,d),l.c.set(u,p,f),l.closestPointToPoint(r,i);const g=r.distanceToSquared(i);g<n&&(o.copy(i),n=g,a=m)})),{point:o,distance:Math.sqrt(n),faceIndex:a}}const h=new s.PlaneGeometry(1,1);function d(){return h}const u=(e,t)=>{t=t||[];for(let e=0;e<8;e++)t[e]=t[e]||new s.Vector3;return t[0].set(e.min.x,e.min.y,e.min.z),t[1].set(e.min.x,e.max.y,e.min.z),t[2].set(e.max.x,e.max.y,e.min.z),t[3].set(e.max.x,e.min.y,e.min.z),t[4].set(e.min.x,e.min.y,e.max.z),t[5].set(e.min.x,e.max.y,e.max.z),t[6].set(e.max.x,e.max.y,e.max.z),t[7].set(e.max.x,e.min.y,e.max.z),t},p=(()=>{const e=new s.Vector3,t=new s.Vector3;return(n,r,i)=>{r=r||new s.Box3,e.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),t.set(Number.MIN_VALUE,Number.MIN_VALUE,Number.MIN_VALUE);for(const s of n)i&&s.applyMatrix4(i),e.x=Math.min(e.x,s.x),e.y=Math.min(e.y,s.y),e.z=Math.min(e.z,s.z),t.x=Math.max(t.x,s.x),t.y=Math.max(t.y,s.y),t.z=Math.max(t.z,s.z);return r.min.copy(e),r.max.copy(t),r}})()},74025:(e,t,n)=>{n.d(t,{$J:()=>c,BE:()=>u,Bw:()=>o,Gm:()=>r,Ne:()=>d,Q7:()=>s,Xe:()=>i,b_:()=>a,bf:()=>p,nw:()=>h,yj:()=>l});const s=0,r=1,i=2,o=0,a=1,l=2,c=1.25,h=1,d=32,u=65535,p=Math.pow(2,-24)},79545:(e,t,n)=>{n.d(t,{G:()=>le});var s=n(68909),r=n(74025);class i{constructor(){}}function o(e,t,n){return n.min.x=t[e],n.min.y=t[e+1],n.min.z=t[e+2],n.max.x=t[e+3],n.max.y=t[e+4],n.max.z=t[e+5],n}function a(e){let t=-1,n=-1/0;for(let s=0;s<3;s++){const r=e[s+3]-e[s];r>n&&(n=r,t=s)}return t}function l(e,t){t.set(e)}function c(e,t,n){let s,r;for(let i=0;i<3;i++){const o=i+3;s=e[i],r=t[i],n[i]=s<r?s:r,s=e[o],r=t[o],n[o]=s>r?s:r}}function h(e,t,n){for(let s=0;s<3;s++){const r=t[e+2*s],i=t[e+2*s+1],o=r-i,a=r+i;o<n[s]&&(n[s]=o),a>n[s+3]&&(n[s+3]=a)}}function d(e){const t=e[3]-e[0],n=e[4]-e[1],s=e[5]-e[2];return 2*(t*n+n*s+s*t)}function u(e,t,n,s,r=null){let i=1/0,o=1/0,a=1/0,l=-1/0,c=-1/0,h=-1/0,d=1/0,u=1/0,p=1/0,f=-1/0,m=-1/0,g=-1/0;const x=null!==r;for(let s=6*t,r=6*(t+n);s<r;s+=6){const t=e[s+0],n=e[s+1],r=t-n,y=t+n;r<i&&(i=r),y>l&&(l=y),x&&t<d&&(d=t),x&&t>f&&(f=t);const b=e[s+2],w=e[s+3],_=b-w,T=b+w;_<o&&(o=_),T>c&&(c=T),x&&b<u&&(u=b),x&&b>m&&(m=b);const v=e[s+4],S=e[s+5],M=v-S,C=v+S;M<a&&(a=M),C>h&&(h=C),x&&v<p&&(p=v),x&&v>g&&(g=v)}s[0]=i,s[1]=o,s[2]=a,s[3]=l,s[4]=c,s[5]=h,x&&(r[0]=d,r[1]=u,r[2]=p,r[3]=f,r[4]=m,r[5]=g)}const p=32,f=(e,t)=>e.candidate-t.candidate,m=new Array(p).fill().map((()=>({count:0,bounds:new Float32Array(6),rightCacheBounds:new Float32Array(6),leftCacheBounds:new Float32Array(6),candidate:0}))),g=new Float32Array(6);function x(e,t){function n(e){M&&M(e/C)}function o(t,s,x,M=null,C=0){if(!A&&C>=_&&(A=!0,T&&(console.warn(`MeshBVH: Max depth of ${_} reached when generating BVH. Consider increasing maxDepth.`),console.warn(e))),x<=v||C>=_)return n(s+x),t.offset=s,t.count=x,t;const L=function(e,t,n,s,i,o){let u=-1,x=0;if(o===r.Q7)u=a(t),-1!==u&&(x=(t[u]+t[u+3])/2);else if(o===r.Gm)u=a(e),-1!==u&&(x=function(e,t,n,s){let r=0;for(let i=t,o=t+n;i<o;i++)r+=e[6*i+2*s];return r/n}(n,s,i,u));else if(o===r.Xe){const o=d(e);let a=r.$J*i;const y=6*s,b=6*(s+i);for(let e=0;e<3;e++){const s=t[e],w=(t[e+3]-s)/p;if(i<8){const t=[...m];t.length=i;let s=0;for(let r=y;r<b;r+=6,s++){const i=t[s];i.candidate=n[r+2*e],i.count=0;const{bounds:o,leftCacheBounds:a,rightCacheBounds:l}=i;for(let e=0;e<3;e++)l[e]=1/0,l[e+3]=-1/0,a[e]=1/0,a[e+3]=-1/0,o[e]=1/0,o[e+3]=-1/0;h(r,n,o)}t.sort(f);let l=i;for(let e=0;e<l;e++){const n=t[e];for(;e+1<l&&t[e+1].candidate===n.candidate;)t.splice(e+1,1),l--}for(let s=y;s<b;s+=6){const r=n[s+2*e];for(let e=0;e<l;e++){const i=t[e];r>=i.candidate?h(s,n,i.rightCacheBounds):(h(s,n,i.leftCacheBounds),i.count++)}}for(let n=0;n<l;n++){const s=t[n],l=s.count,c=i-s.count,h=s.leftCacheBounds,p=s.rightCacheBounds;let f=0;0!==l&&(f=d(h)/o);let m=0;0!==c&&(m=d(p)/o);const g=r.nw+r.$J*(f*l+m*c);g<a&&(u=e,a=g,x=s.candidate)}}else{for(let e=0;e<p;e++){const t=m[e];t.count=0,t.candidate=s+w+e*w;const n=t.bounds;for(let e=0;e<3;e++)n[e]=1/0,n[e+3]=-1/0}for(let t=y;t<b;t+=6){let r=~~((n[t+2*e]-s)/w);r>=p&&(r=31);const i=m[r];i.count++,h(t,n,i.bounds)}const t=m[31];l(t.bounds,t.rightCacheBounds);for(let e=30;e>=0;e--){const t=m[e],n=m[e+1];c(t.bounds,n.rightCacheBounds,t.rightCacheBounds)}let f=0;for(let t=0;t<31;t++){const n=m[t],s=n.count,h=n.bounds,p=m[t+1].rightCacheBounds;0!==s&&(0===f?l(h,g):c(h,g,g)),f+=s;let y=0,b=0;0!==f&&(y=d(g)/o);const w=i-f;0!==w&&(b=d(p)/o);const _=r.nw+r.$J*(y*f+b*w);_<a&&(u=e,a=_,x=n.candidate)}}}}else console.warn(`MeshBVH: Invalid build strategy value ${o} used.`);return{axis:u,pos:x}}(t.boundingData,M,b,s,x,S);if(-1===L.axis)return n(s+x),t.offset=s,t.count=x,t;const B=function(e,t,n,s,r){let i=n,o=n+s-1;const a=r.pos,l=2*r.axis;for(;;){for(;i<=o&&t[6*i+l]<a;)i++;for(;i<=o&&t[6*o+l]>=a;)o--;if(!(i<o))return i;for(let n=0;n<3;n++){let s=e[3*i+n];e[3*i+n]=e[3*o+n],e[3*o+n]=s;let r=t[6*i+2*n+0];t[6*i+2*n+0]=t[6*o+2*n+0],t[6*o+2*n+0]=r;let a=t[6*i+2*n+1];t[6*i+2*n+1]=t[6*o+2*n+1],t[6*o+2*n+1]=a}i++,o--}}(w,b,s,x,L);if(B===s||B===s+x)n(s+x),t.offset=s,t.count=x;else{t.splitAxis=L.axis;const e=new i,n=s,r=B-s;t.left=e,e.boundingData=new Float32Array(6),u(b,n,r,e.boundingData,y),o(e,n,r,y,C+1);const a=new i,l=B,c=x-r;t.right=a,a.boundingData=new Float32Array(6),u(b,l,c,a.boundingData,y),o(a,l,c,y,C+1)}return t}!function(e,t){if(!e.index){const n=e.attributes.position.count,r=t.useSharedArrayBuffer?SharedArrayBuffer:ArrayBuffer;let i;i=n>65535?new Uint32Array(new r(4*n)):new Uint16Array(new r(2*n)),e.setIndex(new s.BufferAttribute(i,1));for(let e=0;e<n;e++)i[e]=e}}(e,t);const x=new Float32Array(6),y=new Float32Array(6),b=function(e,t){const n=e.attributes.position,s=e.index.array,i=s.length/3,o=new Float32Array(6*i),a=n.normalized,l=n.array,c=n.offset||0;let h=3;n.isInterleavedBufferAttribute&&(h=n.data.stride);const d=["getX","getY","getZ"];for(let e=0;e<i;e++){const i=3*e,u=6*e;let p,f,m;a?(p=s[i+0],f=s[i+1],m=s[i+2]):(p=s[i+0]*h+c,f=s[i+1]*h+c,m=s[i+2]*h+c);for(let e=0;e<3;e++){let s,i,c;a?(s=n[d[e]](p),i=n[d[e]](f),c=n[d[e]](m)):(s=l[p+e],i=l[f+e],c=l[m+e]);let h=s;i<h&&(h=i),c<h&&(h=c);let g=s;i>g&&(g=i),c>g&&(g=c);const x=(g-h)/2,y=2*e;o[u+y+0]=h+x,o[u+y+1]=x+(Math.abs(h)+x)*r.bf,h<t[e]&&(t[e]=h),g>t[e+3]&&(t[e+3]=g)}}return o}(e,x),w=e.index.array,_=t.maxDepth,T=t.verbose,v=t.maxLeafTris,S=t.strategy,M=t.onProgress,C=e.index.count/3;let A=!1;const L=[],B=function(e){if(!e.groups||!e.groups.length)return[{offset:0,count:e.index.count/3}];const t=[],n=new Set;for(const t of e.groups)n.add(t.start),n.add(t.start+t.count);const s=Array.from(n.values()).sort(((e,t)=>e-t));for(let e=0;e<s.length-1;e++){const n=s[e],r=s[e+1];t.push({offset:n/3,count:(r-n)/3})}return t}(e);if(1===B.length){const e=B[0],t=new i;t.boundingData=x,function(e,t,n,s){let r=1/0,i=1/0,o=1/0,a=-1/0,l=-1/0,c=-1/0;for(let s=6*t,h=6*(t+n);s<h;s+=6){const t=e[s+0];t<r&&(r=t),t>a&&(a=t);const n=e[s+2];n<i&&(i=n),n>l&&(l=n);const h=e[s+4];h<o&&(o=h),h>c&&(c=h)}s[0]=r,s[1]=i,s[2]=o,s[3]=a,s[4]=l,s[5]=c}(b,e.offset,e.count,y),o(t,e.offset,e.count,y),L.push(t)}else for(let e of B){const t=new i;t.boundingData=new Float32Array(6),u(b,e.offset,e.count,t.boundingData,y),o(t,e.offset,e.count,y),L.push(t)}return L}class y{constructor(){this.min=1/0,this.max=-1/0}setFromPointsField(e,t){let n=1/0,s=-1/0;for(let r=0,i=e.length;r<i;r++){const i=e[r][t];n=i<n?i:n,s=i>s?i:s}this.min=n,this.max=s}setFromPoints(e,t){let n=1/0,s=-1/0;for(let r=0,i=t.length;r<i;r++){const i=t[r],o=e.dot(i);n=o<n?o:n,s=o>s?o:s}this.min=n,this.max=s}isSeparated(e){return this.min>e.max||e.min>this.max}}y.prototype.setFromBox=function(){const e=new s.Vector3;return function(t,n){const s=n.min,r=n.max;let i=1/0,o=-1/0;for(let n=0;n<=1;n++)for(let a=0;a<=1;a++)for(let l=0;l<=1;l++){e.x=s.x*n+r.x*(1-n),e.y=s.y*a+r.y*(1-a),e.z=s.z*l+r.z*(1-l);const c=t.dot(e);i=Math.min(c,i),o=Math.max(c,o)}this.min=i,this.max=o}}();!function(){const e=new y}();const b=function(){const e=new s.Vector3,t=new s.Vector3,n=new s.Vector3;return function(s,r,i){const o=s.start,a=e,l=r.start,c=t;n.subVectors(o,l),e.subVectors(s.end,s.start),t.subVectors(r.end,r.start);const h=n.dot(c),d=c.dot(a),u=c.dot(c),p=n.dot(a),f=a.dot(a)*u-d*d;let m,g;m=0!==f?(h*d-p*u)/f:0,g=(h+m*d)/u,i.x=m,i.y=g}}(),w=function(){const e=new s.Vector2,t=new s.Vector3,n=new s.Vector3;return function(s,r,i,o){b(s,r,e);let a=e.x,l=e.y;if(a>=0&&a<=1&&l>=0&&l<=1)return s.at(a,i),void r.at(l,o);if(a>=0&&a<=1)return l<0?r.at(0,o):r.at(1,o),void s.closestPointToPoint(o,!0,i);if(l>=0&&l<=1)return a<0?s.at(0,i):s.at(1,i),void r.closestPointToPoint(i,!0,o);{let e,c;e=a<0?s.start:s.end,c=l<0?r.start:r.end;const h=t,d=n;return s.closestPointToPoint(c,!0,t),r.closestPointToPoint(e,!0,n),h.distanceToSquared(c)<=d.distanceToSquared(e)?(i.copy(h),void o.copy(c)):(i.copy(e),void o.copy(d))}}}(),_=function(){const e=new s.Vector3,t=new s.Vector3,n=new s.Plane,r=new s.Line3;return function(s,i){const{radius:o,center:a}=s,{a:l,b:c,c:h}=i;r.start=l,r.end=c;if(r.closestPointToPoint(a,!0,e).distanceTo(a)<=o)return!0;r.start=l,r.end=h;if(r.closestPointToPoint(a,!0,e).distanceTo(a)<=o)return!0;r.start=c,r.end=h;if(r.closestPointToPoint(a,!0,e).distanceTo(a)<=o)return!0;const d=i.getPlane(n);if(Math.abs(d.distanceToPoint(a))<=o){const e=d.projectPoint(a,t);if(i.containsPoint(e))return!0}return!1}}();function T(e){return Math.abs(e)<1e-15}class v extends s.Triangle{constructor(...e){super(...e),this.isExtendedTriangle=!0,this.satAxes=new Array(4).fill().map((()=>new s.Vector3)),this.satBounds=new Array(4).fill().map((()=>new y)),this.points=[this.a,this.b,this.c],this.sphere=new s.Sphere,this.plane=new s.Plane,this.needsUpdate=!0}intersectsSphere(e){return _(e,this)}update(){const e=this.a,t=this.b,n=this.c,s=this.points,r=this.satAxes,i=this.satBounds,o=r[0],a=i[0];this.getNormal(o),a.setFromPoints(o,s);const l=r[1],c=i[1];l.subVectors(e,t),c.setFromPoints(l,s);const h=r[2],d=i[2];h.subVectors(t,n),d.setFromPoints(h,s);const u=r[3],p=i[3];u.subVectors(n,e),p.setFromPoints(u,s),this.sphere.setFromPoints(this.points),this.plane.setFromNormalAndCoplanarPoint(o,e),this.needsUpdate=!1}}v.prototype.closestPointToSegment=function(){const e=new s.Vector3,t=new s.Vector3,n=new s.Line3;return function(s,r=null,i=null){const{start:o,end:a}=s,l=this.points;let c,h=1/0;for(let o=0;o<3;o++){const a=(o+1)%3;n.start.copy(l[o]),n.end.copy(l[a]),w(n,s,e,t),c=e.distanceToSquared(t),c<h&&(h=c,r&&r.copy(e),i&&i.copy(t))}return this.closestPointToPoint(o,e),c=o.distanceToSquared(e),c<h&&(h=c,r&&r.copy(e),i&&i.copy(o)),this.closestPointToPoint(a,e),c=a.distanceToSquared(e),c<h&&(h=c,r&&r.copy(e),i&&i.copy(a)),Math.sqrt(h)}}(),v.prototype.intersectsTriangle=function(){const e=new v,t=new Array(3),n=new Array(3),r=new y,i=new y,o=new s.Vector3,a=new s.Vector3,l=new s.Vector3,c=new s.Vector3,h=new s.Line3,d=new s.Line3,u=new s.Line3;return function(s,p=null,f=!1){this.needsUpdate&&this.update(),s.isExtendedTriangle?s.needsUpdate&&s.update():(e.copy(s),e.update(),s=e);const m=this.plane,g=s.plane;if(Math.abs(m.normal.dot(g.normal))>1-1e-10){const e=this.satBounds,a=this.satAxes;n[0]=s.a,n[1]=s.b,n[2]=s.c;for(let t=0;t<4;t++){const s=e[t],i=a[t];if(r.setFromPoints(i,n),s.isSeparated(r))return!1}const l=s.satBounds,c=s.satAxes;t[0]=this.a,t[1]=this.b,t[2]=this.c;for(let e=0;e<4;e++){const n=l[e],s=c[e];if(r.setFromPoints(s,t),n.isSeparated(r))return!1}for(let e=0;e<4;e++){const s=a[e];for(let e=0;e<4;e++){const a=c[e];if(o.crossVectors(s,a),r.setFromPoints(o,t),i.setFromPoints(o,n),r.isSeparated(i))return!1}}return p&&(f||console.warn("ExtendedTriangle.intersectsTriangle: Triangles are coplanar which does not support an output edge. Setting edge to 0, 0, 0."),p.start.set(0,0,0),p.end.set(0,0,0)),!0}{const e=this.points;let t=!1,n=0;for(let s=0;s<3;s++){const r=e[s],i=e[(s+1)%3];h.start.copy(r),h.end.copy(i),h.delta(a);const o=t?d.start:d.end,l=T(g.distanceToPoint(r));if(T(g.normal.dot(a))&&l){d.copy(h),n=2;break}if((g.intersectLine(h,o)||l)&&!T(o.distanceTo(i))){if(n++,t)break;t=!0}}if(1===n&&s.containsPoint(d.end))return p&&(p.start.copy(d.end),p.end.copy(d.end)),!0;if(2!==n)return!1;const r=s.points;let i=!1,o=0;for(let e=0;e<3;e++){const t=r[e],n=r[(e+1)%3];h.start.copy(t),h.end.copy(n),h.delta(l);const s=i?u.start:u.end,a=T(m.distanceToPoint(t));if(T(m.normal.dot(l))&&a){u.copy(h),o=2;break}if((m.intersectLine(h,s)||a)&&!T(s.distanceTo(n))){if(o++,i)break;i=!0}}if(1===o&&this.containsPoint(u.end))return p&&(p.start.copy(u.end),p.end.copy(u.end)),!0;if(2!==o)return!1;if(d.delta(a),u.delta(l),a.dot(l)<0){let e=u.start;u.start=u.end,u.end=e}const f=d.start.dot(a),x=d.end.dot(a),y=u.start.dot(a),b=u.end.dot(a);return(f===b||y===x||x<y!==f<b)&&(p&&(c.subVectors(d.start,u.start),c.dot(a)>0?p.start.copy(d.start):p.start.copy(u.start),c.subVectors(d.end,u.end),c.dot(a)<0?p.end.copy(d.end):p.end.copy(u.end)),!0)}}}(),v.prototype.distanceToPoint=function(){const e=new s.Vector3;return function(t){return this.closestPointToPoint(t,e),t.distanceTo(e)}}(),v.prototype.distanceToTriangle=function(){const e=new s.Vector3,t=new s.Vector3,n=["a","b","c"],r=new s.Line3,i=new s.Line3;return function(s,o=null,a=null){const l=o||a?r:null;if(this.intersectsTriangle(s,l))return(o||a)&&(o&&l.getCenter(o),a&&l.getCenter(a)),0;let c=1/0;for(let t=0;t<3;t++){let r;const i=n[t],l=s[i];this.closestPointToPoint(l,e),r=l.distanceToSquared(e),r<c&&(c=r,o&&o.copy(e),a&&a.copy(l));const h=this[i];s.closestPointToPoint(h,e),r=h.distanceToSquared(e),r<c&&(c=r,o&&o.copy(h),a&&a.copy(e))}for(let l=0;l<3;l++){const h=n[l],d=n[(l+1)%3];r.set(this[h],this[d]);for(let l=0;l<3;l++){const h=n[l],d=n[(l+1)%3];i.set(s[h],s[d]),w(r,i,e,t);const u=e.distanceToSquared(t);u<c&&(c=u,o&&o.copy(e),a&&a.copy(t))}}return Math.sqrt(c)}}();class S{constructor(e,t,n){this.isOrientedBox=!0,this.min=new s.Vector3,this.max=new s.Vector3,this.matrix=new s.Matrix4,this.invMatrix=new s.Matrix4,this.points=new Array(8).fill().map((()=>new s.Vector3)),this.satAxes=new Array(3).fill().map((()=>new s.Vector3)),this.satBounds=new Array(3).fill().map((()=>new y)),this.alignedSatBounds=new Array(3).fill().map((()=>new y)),this.needsUpdate=!1,e&&this.min.copy(e),t&&this.max.copy(t),n&&this.matrix.copy(n)}set(e,t,n){this.min.copy(e),this.max.copy(t),this.matrix.copy(n),this.needsUpdate=!0}copy(e){this.min.copy(e.min),this.max.copy(e.max),this.matrix.copy(e.matrix),this.needsUpdate=!0}}S.prototype.update=function(){const e=this.matrix,t=this.min,n=this.max,s=this.points;for(let r=0;r<=1;r++)for(let i=0;i<=1;i++)for(let o=0;o<=1;o++){const a=s[1*r|2*i|4*o];a.x=r?n.x:t.x,a.y=i?n.y:t.y,a.z=o?n.z:t.z,a.applyMatrix4(e)}const r=this.satBounds,i=this.satAxes,o=s[0];for(let e=0;e<3;e++){const t=i[e],n=r[e],a=s[1<<e];t.subVectors(o,a),n.setFromPoints(t,s)}const a=this.alignedSatBounds;a[0].setFromPointsField(s,"x"),a[1].setFromPointsField(s,"y"),a[2].setFromPointsField(s,"z"),this.invMatrix.copy(this.matrix).invert(),this.needsUpdate=!1},S.prototype.intersectsBox=function(){const e=new y;return function(t){this.needsUpdate&&this.update();const n=t.min,s=t.max,r=this.satBounds,i=this.satAxes,o=this.alignedSatBounds;if(e.min=n.x,e.max=s.x,o[0].isSeparated(e))return!1;if(e.min=n.y,e.max=s.y,o[1].isSeparated(e))return!1;if(e.min=n.z,e.max=s.z,o[2].isSeparated(e))return!1;for(let n=0;n<3;n++){const s=i[n],o=r[n];if(e.setFromBox(s,t),o.isSeparated(e))return!1}return!0}}(),S.prototype.intersectsTriangle=function(){const e=new v,t=new Array(3),n=new y,r=new y,i=new s.Vector3;return function(s){this.needsUpdate&&this.update(),s.isExtendedTriangle?s.needsUpdate&&s.update():(e.copy(s),e.update(),s=e);const o=this.satBounds,a=this.satAxes;t[0]=s.a,t[1]=s.b,t[2]=s.c;for(let e=0;e<3;e++){const s=o[e],r=a[e];if(n.setFromPoints(r,t),s.isSeparated(n))return!1}const l=s.satBounds,c=s.satAxes,h=this.points;for(let e=0;e<3;e++){const t=l[e],s=c[e];if(n.setFromPoints(s,h),t.isSeparated(n))return!1}for(let e=0;e<3;e++){const s=a[e];for(let e=0;e<4;e++){const o=c[e];if(i.crossVectors(s,o),n.setFromPoints(i,t),r.setFromPoints(i,h),n.isSeparated(r))return!1}}return!0}}(),S.prototype.closestPointToPoint=function(e,t){return this.needsUpdate&&this.update(),t.copy(e).applyMatrix4(this.invMatrix).clamp(this.min,this.max).applyMatrix4(this.matrix),t},S.prototype.distanceToPoint=function(){const e=new s.Vector3;return function(t){return this.closestPointToPoint(t,e),t.distanceTo(e)}}(),S.prototype.distanceToBox=function(){const e=["x","y","z"],t=new Array(12).fill().map((()=>new s.Line3)),n=new Array(12).fill().map((()=>new s.Line3)),r=new s.Vector3,i=new s.Vector3;return function(s,o=0,a=null,l=null){if(this.needsUpdate&&this.update(),this.intersectsBox(s))return(a||l)&&(s.getCenter(i),this.closestPointToPoint(i,r),s.closestPointToPoint(r,i),a&&a.copy(r),l&&l.copy(i)),0;const c=o*o,h=s.min,d=s.max,u=this.points;let p=1/0;for(let e=0;e<8;e++){const t=u[e];i.copy(t).clamp(h,d);const n=t.distanceToSquared(i);if(n<p&&(p=n,a&&a.copy(t),l&&l.copy(i),n<c))return Math.sqrt(n)}let f=0;for(let s=0;s<3;s++)for(let r=0;r<=1;r++)for(let i=0;i<=1;i++){const o=(s+1)%3,a=(s+2)%3,l=1<<s|r<<o|i<<a,c=u[r<<o|i<<a],p=u[l];t[f].set(c,p);const m=e[s],g=e[o],x=e[a],y=n[f],b=y.start,w=y.end;b[m]=h[m],b[g]=r?h[g]:d[g],b[x]=i?h[x]:d[g],w[m]=d[m],w[g]=r?h[g]:d[g],w[x]=i?h[x]:d[g],f++}for(let e=0;e<=1;e++)for(let t=0;t<=1;t++)for(let n=0;n<=1;n++){i.x=e?d.x:h.x,i.y=t?d.y:h.y,i.z=n?d.z:h.z,this.closestPointToPoint(i,r);const s=i.distanceToSquared(r);if(s<p&&(p=s,a&&a.copy(r),l&&l.copy(i),s<c))return Math.sqrt(s)}for(let e=0;e<12;e++){const s=t[e];for(let e=0;e<12;e++){const t=n[e];w(s,t,r,i);const o=r.distanceToSquared(i);if(o<p&&(p=o,a&&a.copy(r),l&&l.copy(i),o<c))return Math.sqrt(o)}}return Math.sqrt(p)}}();var M=n(7662);function C(e,t,n,s){const r=e.a,i=e.b,o=e.c;let a=t,l=t+1,c=t+2;n&&(a=n.getX(t),l=n.getX(t+1),c=n.getX(t+2)),r.x=s.getX(a),r.y=s.getY(a),r.z=s.getZ(a),i.x=s.getX(l),i.y=s.getY(l),i.z=s.getZ(l),o.x=s.getX(c),o.y=s.getY(c),o.z=s.getZ(c)}function A(e,t,n,s,r,i,o){const a=n.index,l=n.attributes.position;for(let n=e,c=t+e;n<c;n++)if(C(o,3*n,a,l),o.needsUpdate=!0,s(o,n,r,i))return!0;return!1}class L{constructor(e){this._getNewPrimitive=e,this._primitives=[]}getPrimitive(){const e=this._primitives;return 0===e.length?this._getNewPrimitive():e.pop()}releasePrimitive(e){this._primitives.push(e)}}function B(e,t){return 65535===t[e+15]}function P(e,t){return t[e+6]}function U(e,t){return t[e+14]}function k(e){return e+8}function R(e,t){return t[e+6]}const V=new s.Box3,O=new s.Vector3,E=["x","y","z"];function F(e,t,n,s,r){let i=2*e,o=j,a=W,l=$;if(B(i,a)){const o=P(e,l),c=U(i,a);(0,M._m)(t,n,s,o,c,r)}else{const i=k(e);N(i,o,s,O)&&F(i,t,n,s,r);const a=R(e,l);N(a,o,s,O)&&F(a,t,n,s,r)}}function D(e,t,n,s){let r=2*e,i=j,o=W,a=$;if(B(r,o)){const i=P(e,a),l=U(r,o);return(0,M.k4)(t,n,s,i,l)}{const r=function(e,t){return t[e+7]}(e,a),o=E[r],l=s.direction[o]>=0;let c,h;l?(c=k(e),h=R(e,a)):(c=R(e,a),h=k(e));const d=N(c,i,s,O)?D(c,t,n,s):null;if(d){const e=d.point[o];if(l?e<=i[h+r]:e>=i[h+r+3])return d}const u=N(h,i,s,O)?D(h,t,n,s):null;return d&&u?d.distance<=u.distance?d:u:d||u||null}}const I=function(){let e,t;const n=[],i=new L((()=>new s.Box3));return function(...s){e=i.getPrimitive(),t=i.getPrimitive(),n.push(e,t);const r=a(...s);i.releasePrimitive(e),i.releasePrimitive(t),n.pop(),n.pop();const o=n.length;return o>0&&(t=n[o-1],e=n[o-2]),r};function a(n,s,i,l,c=null,h=0,d=0){function u(e){let t=2*e,n=W,s=$;for(;!B(t,n);)t=2*(e=k(e));return P(e,s)}function p(e){let t=2*e,n=W,s=$;for(;!B(t,n);)t=2*(e=R(e,s));return P(e,s)+U(t,n)}let f=2*n,m=j,g=W,x=$;if(B(f,g)){const t=P(n,x),s=U(f,g);return o(n,m,e),l(t,s,!1,d,h+n,e)}{const f=k(n),y=R(n,x);let b,w,_,T,v=f,S=y;if(c&&(_=e,T=t,o(v,m,_),o(S,m,T),b=c(_),w=c(T),w<b)){v=y,S=f;const e=b;b=w,w=e,_=T}_||(_=e,o(v,m,_));const M=i(_,B(2*v,g),b,d+1,h+v);let C;if(M===r.yj){const e=u(v);C=l(e,p(v)-e,!0,d+1,h+v,_)}else C=M&&a(v,s,i,l,c,h,d+1);if(C)return!0;T=t,o(S,m,T);const A=i(T,B(2*S,g),w,d+1,h+S);let L;if(A===r.yj){const e=u(S);L=l(e,p(S)-e,!0,d+1,h+S,T)}else L=A&&a(S,s,i,l,c,h,d+1);return!!L}}}(),z=function(){const e=new v,t=new v,n=new s.Matrix4,r=new S,i=new S;return function s(a,l,c,h,d=null){let u=2*a,p=j,f=W,m=$;null===d&&(c.boundingBox||c.computeBoundingBox(),r.set(c.boundingBox.min,c.boundingBox.max,h),d=r);if(!B(u,f)){const e=a+8,t=m[a+6];o(e,p,V);if(d.intersectsBox(V)&&s(e,l,c,h,d))return!0;o(t,p,V);return!!(d.intersectsBox(V)&&s(t,l,c,h,d))}{const s=l,r=s.index,d=s.attributes.position,g=c.index,x=c.attributes.position,y=P(a,m),b=U(u,f);if(n.copy(h).invert(),c.boundsTree){o(a,p,i),i.matrix.copy(n),i.needsUpdate=!0;return c.boundsTree.shapecast({intersectsBounds:e=>i.intersectsBox(e),intersectsTriangle:e=>{e.a.applyMatrix4(h),e.b.applyMatrix4(h),e.c.applyMatrix4(h),e.needsUpdate=!0;for(let n=3*y,s=3*(b+y);n<s;n+=3)if(C(t,n,r,d),t.needsUpdate=!0,e.intersectsTriangle(t))return!0;return!1}})}for(let s=3*y,i=b+3*y;s<i;s+=3){C(e,s,r,d),e.a.applyMatrix4(n),e.b.applyMatrix4(n),e.c.applyMatrix4(n),e.needsUpdate=!0;for(let n=0,s=g.count;n<s;n+=3)if(C(t,n,g,x),t.needsUpdate=!0,e.intersectsTriangle(t))return!0}}}}();function N(e,t,n,s){return o(e,t,V),n.intersectBox(V,s)}const H=[];let G,j,W,$;function Q(e){G&&H.push(G),G=e,j=new Float32Array(e),W=new Uint16Array(e),$=new Uint32Array(e)}function q(){G=null,j=null,W=null,$=null,H.length&&Q(H.pop())}const X=Symbol("skip tree generation"),J=new s.Box3,Z=new s.Box3,K=new s.Matrix4,Y=new S,ee=new S,te=new s.Vector3,ne=new s.Vector3,se=new s.Vector3,re=new s.Vector3,ie=new s.Vector3,oe=new s.Box3,ae=new L((()=>new v));class le{static serialize(e,t={}){if(t.isBufferGeometry)return console.warn("MeshBVH.serialize: The arguments for the function have changed. See documentation for new signature."),le.serialize(arguments[0],{cloneBuffers:void 0===arguments[2]||arguments[2]});t={cloneBuffers:!0,...t};const n=e.geometry,s=e._roots,r=n.getIndex();let i;return i=t.cloneBuffers?{roots:s.map((e=>e.slice())),index:r.array.slice()}:{roots:s,index:r.array},i}static deserialize(e,t,n={}){if("boolean"==typeof n)return console.warn("MeshBVH.deserialize: The arguments for the function have changed. See documentation for new signature."),le.deserialize(arguments[0],arguments[1],{setIndex:void 0===arguments[2]||arguments[2]});n={setIndex:!0,...n};const{index:r,roots:i}=e,o=new le(t,{...n,[X]:!0});if(o._roots=i,n.setIndex){const n=t.getIndex();if(null===n){const n=new s.BufferAttribute(e.index,1,!1);t.setIndex(n)}else n.array!==r&&(n.array.set(r),n.needsUpdate=!0)}return o}constructor(e,t={}){if(!e.isBufferGeometry)throw new Error("MeshBVH: Only BufferGeometries are supported.");if(e.index&&e.index.isInterleavedBufferAttribute)throw new Error("MeshBVH: InterleavedBufferAttribute is not supported for the index attribute.");if((t=Object.assign({strategy:r.Q7,maxDepth:40,maxLeafTris:10,verbose:!0,useSharedArrayBuffer:!1,setBoundingBox:!0,onProgress:null,[X]:!1},t)).useSharedArrayBuffer&&"undefined"==typeof SharedArrayBuffer)throw new Error("MeshBVH: SharedArrayBuffer is not available.");this._roots=null,t[X]||(this._roots=function(e,t){const n=x(e,t);let s,i,o;const a=[],l=t.useSharedArrayBuffer?SharedArrayBuffer:ArrayBuffer;for(let e=0;e<n.length;e++){const t=n[e];let d=c(t);const u=new l(r.Ne*d);s=new Float32Array(u),i=new Uint32Array(u),o=new Uint16Array(u),h(0,t),a.push(u)}return a;function c(e){return e.count?1:1+c(e.left)+c(e.right)}function h(e,t){const n=e/4,a=e/2,l=!!t.count,c=t.boundingData;for(let e=0;e<6;e++)s[n+e]=c[e];if(l){const s=t.offset,l=t.count;return i[n+6]=s,o[a+14]=l,o[a+15]=r.BE,e+r.Ne}{const s=t.left,o=t.right,a=t.splitAxis;let l;if(l=h(e+r.Ne,s),l/4>Math.pow(2,32))throw new Error("MeshBVH: Cannot store child pointer greater than 32 bits.");return i[n+6]=l/4,l=h(l,o),i[n+7]=a,l}}}(e,t),!e.boundingBox&&t.setBoundingBox&&(e.boundingBox=this.getBoundingBox(new s.Box3))),this.geometry=e}refit(e=null){e&&Array.isArray(e)&&(e=new Set(e));const t=this.geometry,n=t.index.array,s=t.attributes.position;let i,o,a,l,c=0;const h=this._roots;for(let e=0,t=h.length;e<t;e++)i=h[e],o=new Uint32Array(i),a=new Uint16Array(i),l=new Float32Array(i),d(0,c),c+=i.byteLength;function d(t,i,c=!1){const h=2*t;if(a[h+15]===r.BE){const e=o[t+6];let r=1/0,i=1/0,c=1/0,d=-1/0,u=-1/0,p=-1/0;for(let t=3*e,o=3*(e+a[h+14]);t<o;t++){const e=n[t],o=s.getX(e),a=s.getY(e),l=s.getZ(e);o<r&&(r=o),o>d&&(d=o),a<i&&(i=a),a>u&&(u=a),l<c&&(c=l),l>p&&(p=l)}return(l[t+0]!==r||l[t+1]!==i||l[t+2]!==c||l[t+3]!==d||l[t+4]!==u||l[t+5]!==p)&&(l[t+0]=r,l[t+1]=i,l[t+2]=c,l[t+3]=d,l[t+4]=u,l[t+5]=p,!0)}{const n=t+8,s=o[t+6],r=n+i,a=s+i;let h=c,u=!1,p=!1;e?h||(u=e.has(r),p=e.has(a),h=!u&&!p):(u=!0,p=!0);const f=h||p;let m=!1;(h||u)&&(m=d(n,i,h));let g=!1;f&&(g=d(s,i,h));const x=m||g;if(x)for(let e=0;e<3;e++){const r=n+e,i=s+e,o=l[r],a=l[r+3],c=l[i],h=l[i+3];l[t+e]=o<c?o:c,l[t+e+3]=a>h?a:h}return x}}}traverse(e,t=0){const n=this._roots[t],s=new Uint32Array(n),i=new Uint16Array(n);!function t(o,a=0){const l=2*o,c=i[l+15]===r.BE;if(c){const t=s[o+6],r=i[l+14];e(a,c,new Float32Array(n,4*o,6),t,r)}else{const i=o+r.Ne/4,l=s[o+6],h=s[o+7];e(a,c,new Float32Array(n,4*o,6),h)||(t(i,a+1),t(l,a+1))}}(0)}raycast(e,t=s.FrontSide){const n=this._roots,r=this.geometry,i=[],o=t.isMaterial,a=Array.isArray(t),l=r.groups,c=o?t.side:t;for(let s=0,o=n.length;s<o;s++){const o=a?t[l[s].materialIndex].side:c,h=i.length;if(Q(n[s]),F(0,r,o,e,i),q(),a){const e=l[s].materialIndex;for(let t=h,n=i.length;t<n;t++)i[t].face.materialIndex=e}}return i}raycastFirst(e,t=s.FrontSide){const n=this._roots,r=this.geometry,i=t.isMaterial,o=Array.isArray(t);let a=null;const l=r.groups,c=i?t.side:t;for(let s=0,i=n.length;s<i;s++){const i=o?t[l[s].materialIndex].side:c;Q(n[s]);const h=D(0,r,i,e);q(),null!=h&&(null==a||h.distance<a.distance)&&(a=h,o&&(h.face.materialIndex=l[s].materialIndex))}return a}intersectsGeometry(e,t){const n=this.geometry;let s=!1;for(const r of this._roots)if(Q(r),s=z(0,n,e,t),q(),s)break;return s}shapecast(e,t,n){const s=this.geometry;if(e instanceof Function){if(t){const e=t;t=(t,n,s,r)=>{const i=3*n;return e(t,i,i+1,i+2,s,r)}}e={boundsTraverseOrder:n,intersectsBounds:e,intersectsTriangle:t,intersectsRange:null},console.warn("MeshBVH: Shapecast function signature has changed and now takes an object of callbacks as a second argument. See docs for new signature.")}const r=ae.getPrimitive();let{boundsTraverseOrder:i,intersectsBounds:o,intersectsRange:a,intersectsTriangle:l}=e;if(a&&l){const e=a;a=(t,n,i,o,a)=>!!e(t,n,i,o,a)||A(t,n,s,l,i,o,r)}else a||(a=l?(e,t,n,i)=>A(e,t,s,l,n,i,r):(e,t,n)=>n);let c=!1,h=0;for(const e of this._roots){if(Q(e),c=I(0,s,o,a,i,h),q(),c)break;h+=e.byteLength}return ae.releasePrimitive(r),c}bvhcast(e,t,n){let{intersectsRanges:s,intersectsTriangles:r}=n;const i=this.geometry.index,o=this.geometry.attributes.position,a=e.geometry.index,l=e.geometry.attributes.position;K.copy(t).invert();const c=ae.getPrimitive(),h=ae.getPrimitive();if(r){function u(e,n,s,d,u,p,f,m){for(let g=s,x=s+d;g<x;g++){C(h,3*g,a,l),h.a.applyMatrix4(t),h.b.applyMatrix4(t),h.c.applyMatrix4(t),h.needsUpdate=!0;for(let t=e,s=e+n;t<s;t++)if(C(c,3*t,i,o),c.needsUpdate=!0,r(c,h,t,g,u,p,f,m))return!0}return!1}if(s){const p=s;s=function(e,t,n,s,r,i,o,a){return!!p(e,t,n,s,r,i,o,a)||u(e,t,n,s,r,i,o,a)}}else s=u}e.getBoundingBox(Z),Z.applyMatrix4(t);const d=this.shapecast({intersectsBounds:e=>Z.intersectsBox(e),intersectsRange:(t,n,r,i,o,a)=>(J.copy(a),J.applyMatrix4(K),e.shapecast({intersectsBounds:e=>J.intersectsBox(e),intersectsRange:(e,r,a,l,c)=>s(t,n,e,r,i,o,l,c)}))});return ae.releasePrimitive(c),ae.releasePrimitive(h),d}intersectsBox(e,t){return Y.set(e.min,e.max,t),Y.needsUpdate=!0,this.shapecast({intersectsBounds:e=>Y.intersectsBox(e),intersectsTriangle:e=>Y.intersectsTriangle(e)})}intersectsSphere(e){return this.shapecast({intersectsBounds:t=>e.intersectsBox(t),intersectsTriangle:t=>t.intersectsSphere(e)})}closestPointToGeometry(e,t,n={},s={},r=0,i=1/0){e.boundingBox||e.computeBoundingBox(),Y.set(e.boundingBox.min,e.boundingBox.max,t),Y.needsUpdate=!0;const o=this.geometry,a=o.attributes.position,l=o.index,c=e.attributes.position,h=e.index,d=ae.getPrimitive(),u=ae.getPrimitive();let p=ne,f=se,m=null,g=null;s&&(m=re,g=ie);let x=1/0,y=null,b=null;return K.copy(t).invert(),ee.matrix.copy(K),this.shapecast({boundsTraverseOrder:e=>Y.distanceToBox(e),intersectsBounds:(e,t,n)=>n<x&&n<i&&(t&&(ee.min.copy(e.min),ee.max.copy(e.max),ee.needsUpdate=!0),!0),intersectsRange:(n,s)=>{if(e.boundsTree)return e.boundsTree.shapecast({boundsTraverseOrder:e=>ee.distanceToBox(e),intersectsBounds:(e,t,n)=>n<x&&n<i,intersectsRange:(e,i)=>{for(let o=3*e,w=3*(e+i);o<w;o+=3){C(u,o,h,c),u.a.applyMatrix4(t),u.b.applyMatrix4(t),u.c.applyMatrix4(t),u.needsUpdate=!0;for(let e=3*n,t=3*(n+s);e<t;e+=3){C(d,e,l,a),d.needsUpdate=!0;const t=d.distanceToTriangle(u,p,m);if(t<x&&(f.copy(p),g&&g.copy(m),x=t,y=e/3,b=o/3),t<r)return!0}}}});for(let e=0,i=h?h.count:c.count;e<i;e+=3){C(u,e,h,c),u.a.applyMatrix4(t),u.b.applyMatrix4(t),u.c.applyMatrix4(t),u.needsUpdate=!0;for(let t=3*n,i=3*(n+s);t<i;t+=3){C(d,t,l,a),d.needsUpdate=!0;const n=d.distanceToTriangle(u,p,m);if(n<x&&(f.copy(p),g&&g.copy(m),x=n,y=t/3,b=e/3),n<r)return!0}}}}),ae.releasePrimitive(d),ae.releasePrimitive(u),x===1/0?null:(n.point?n.point.copy(f):n.point=f.clone(),n.distance=x,n.faceIndex=y,s&&(s.point?s.point.copy(g):s.point=g.clone(),s.point.applyMatrix4(K),f.applyMatrix4(K),s.distance=f.sub(s.point).length(),s.faceIndex=b),n)}closestPointToPoint(e,t={},n=0,s=1/0){const r=n*n,i=s*s;let o=1/0,a=null;if(this.shapecast({boundsTraverseOrder:t=>(te.copy(e).clamp(t.min,t.max),te.distanceToSquared(e)),intersectsBounds:(e,t,n)=>n<o&&n<i,intersectsTriangle:(t,n)=>{t.closestPointToPoint(e,te);const s=e.distanceToSquared(te);return s<o&&(ne.copy(te),o=s,a=n),s<r}}),o===1/0)return null;const l=Math.sqrt(o);return t.point?t.point.copy(ne):t.point=ne.clone(),t.distance=l,t.faceIndex=a,t}getBoundingBox(e){e.makeEmpty();return this._roots.forEach((t=>{o(0,new Float32Array(t),oe),e.union(oe)})),e}}},7662:(e,t,n)=>{n.d(t,{sP:()=>y,k4:()=>x,_m:()=>g});var s=n(68909);const r=new s.Vector3,i=new s.Vector3,o=new s.Vector3,a=new s.Vector2,l=new s.Vector2,c=new s.Vector2,h=new s.Vector3,d=new s.Vector3,u=new s.Vector3,p=new s.Vector3;function f(e,t,n,f,m,g,x,y,b){r.fromBufferAttribute(t,g),i.fromBufferAttribute(t,x),o.fromBufferAttribute(t,y);const w=function(e,t,n,r,i,o){let a;return a=o===s.BackSide?e.intersectTriangle(r,n,t,!0,i):e.intersectTriangle(t,n,r,o!==s.DoubleSide,i),null===a?null:{distance:e.origin.distanceTo(i),point:i.clone()}}(e,r,i,o,p,b);if(w){f&&(a.fromBufferAttribute(f,g),l.fromBufferAttribute(f,x),c.fromBufferAttribute(f,y),w.uv=s.Triangle.getInterpolation(p,r,i,o,a,l,c,new s.Vector2)),m&&(a.fromBufferAttribute(m,g),l.fromBufferAttribute(m,x),c.fromBufferAttribute(m,y),w.uv1=s.Triangle.getInterpolation(p,r,i,o,a,l,c,new s.Vector2)),n&&(h.fromBufferAttribute(n,g),d.fromBufferAttribute(n,x),u.fromBufferAttribute(n,y),w.normal=s.Triangle.getInterpolation(p,r,i,o,h,d,u,new s.Vector3),w.normal.dot(e.direction)>0&&w.normal.multiplyScalar(-1));const t={a:g,b:x,c:y,normal:new s.Vector3,materialIndex:0};s.Triangle.getNormal(r,i,o,t.normal),w.face=t,w.faceIndex=g}return w}function m(e,t,n,s,r){const i=3*s,o=e.index.getX(i),a=e.index.getX(i+1),l=e.index.getX(i+2),{position:c,normal:h,uv:d,uv1:u}=e.attributes,p=f(n,c,h,d,u,o,a,l,t);return p?(p.faceIndex=s,r&&r.push(p),p):null}function g(e,t,n,s,r,i){for(let o=s,a=s+r;o<a;o++)m(e,t,n,o,i)}function x(e,t,n,s,r){let i=1/0,o=null;for(let a=s,l=s+r;a<l;a++){const s=m(e,t,n,a);s&&s.distance<i&&(o=s,i=s.distance)}return o}function y(e,t,n){return null===e?null:(e.point.applyMatrix4(t.matrixWorld),e.distance=e.point.distanceTo(n.ray.origin),e.object=t,e.distance<n.near||e.distance>n.far?null:e)}}}]);