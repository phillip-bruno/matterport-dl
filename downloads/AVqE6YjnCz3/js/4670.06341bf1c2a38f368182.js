"use strict";(self.webpackChunkmp_webgl=self.webpackChunkmp_webgl||[]).push([[4670],{22299:(t,e,i)=>{i.d(e,{J:()=>n});var s=i(92237),o=i(84710);class n extends o.B{constructor(){super(),this.name="cursor",this.opacity=new s.z(0),this.texture=null}}},44667:(t,e,i)=>{i.d(e,{s:()=>o});var s=i(92475);class o extends s.E{constructor(t,e,i){super(),this.position=t,this.delta=e,this.viewport=i}}},70497:(t,e,i)=>{var s;i.d(e,{X:()=>s}),function(t){t[t.Min=0]="Min",t[t.Standard=1]="Standard",t[t.High=2]="High",t[t.Detail=3]="Detail"}(s||(s={}))},32484:(t,e,i)=>{i.d(e,{yJ:()=>r});var s=i(80112),o=i(47299),n=i(14971);const r={TEXTURE_SETTINGS:o.Ay,TILEDMESH_SETTINGS:s.W,clearRaycastHits:n.Jn}},80112:(t,e,i)=>{i.d(e,{W:()=>r});var s=i(64491),o=i(75778),n=i(70497);const r={urlTemplateToken:"<file>",initialMaxLOD:n.X.Min,nonMeshMaxLOD:n.X.Standard,maxLOD:n.X.High,minLOD:n.X.Min,loadSiblings:!0,displayActiveTiles:!1,autoDisableRendererCulling:!0,optimizeRaycast:!1,stopAtEmptyTiles:!1,disableTileUpdates:!1,disposeModel:!1,limitMemoryUsage:(0,s.Fr)(),allocatedMegsBeforeLimitingLod:350,lruMinExtraTiles:(0,s.Fr)()?0:100,lruMaxTiles:800,lruUnloadPercent:.05,downloadQueueConcurrency:8,parseQueueConcurrency:10,snappingMaxLOD:n.X.Standard,errorTarget:Number((0,o.P3)("errorTarget",(0,s.Fr)()?6:4)),errorMultiplierHiddenFloors:.01,errorMultiplierRaycastOcclusion:.1,smallMeshThreshold:Number((0,o.P3)("smallMeshThreshold",40)),smallMeshErrorMultiplier:Number((0,o.P3)("smallMeshErrorMultiplier",.1))}},14971:(t,e,i)=>{i.d(e,{Jn:()=>d,rt:()=>h});var s=i(68909);const o=i(47299).Ay.sightingMaxAge,n=new s.Color;let r,a=-1;const h=(t,e,i)=>{r||(r=new s.InstancedMesh(new s.SphereGeometry(.005,8,4),new s.MeshBasicMaterial,o),r.frustumCulled=!1,c(r));const h=new s.Matrix4;return({point:s,distance:d})=>{const c=d/i.fovDistanceScale();h.makeScale(c,c,c).setPosition(s),r.setMatrixAt(++a%o,h),r.instanceMatrix.needsUpdate=!0;for(let e=o;e--;)r.setColorAt((a-e+o)%o,n.setHex(t).multiplyScalar(1-e/o));r.instanceColor&&(r.instanceColor.needsUpdate=!0),r.parent||e.scene.add(r)}},d=()=>{var t;r&&(null===(t=r.parent)||void 0===t||t.remove(r),c(r))};function c(t){const e=(new s.Matrix4).makeScale(0,0,0);for(let i=0;i<o;i++)t.setMatrixAt(i,e)}new s.Vector4(1,0,0,1),new s.Vector4(0,1,0,1),new s.Vector4(0,0,1,1),new s.Vector4(1,1,0,1),new s.Vector4(1,0,1,1),new s.Vector4(1,1,1,1),new s.Vector4(0,1,1,1),new s.Vector4(0,0,0,1)},3680:(t,e,i)=>{i.d(e,{e:()=>h});var s=i(58499),o=i(1333),n=i(81662),r=i(68909),a=i(2993);class h{constructor(t,e,i,r,h,d,c){var l,u;this.options=t,this.settingsData=i,this.cameraPose=r,this.rotate=h,this.stopRotating=d,this.getCurve=c,this.type=o.gX.Burns,this.toIndex=-1,this.started=-1,this.stopped=-1,this.duration=0,this.direction=o.ND.Auto,this.degrees=0,this.adjustedPanSpeed=0,this.currentTransitionPromise=null,this.onStopRequested=()=>Promise.resolve();const{path:p,snapshot:m,nextSnapshot:g}=t,w=s.A.getPanValues(this.settingsData,!1,t.panOverrides);this.degrees=w.degrees,this.duration=null!==(l=t.duration)&&void 0!==l?l:w.ms,this.toIndex=e;const T=null!==(u=w.direction)&&void 0!==u?u:o.ND.Auto;let v=w.radiansPerMs;if(void 0!==T&&T!==o.ND.Auto)v*=T;else if(p){const t=this.cameraPose.position.clone().setY(0),e=p.map((t=>t.position)),i=this.getCurve(e).curve.getPointAt(.1).setY(0).clone().sub(t).normalize(),s=n.B1.FORWARD.clone().applyQuaternion(this.cameraPose.rotation),o=Math.sign(s.cross(i).y);v=0!==o?v*o:v}else if(g&&m){if(!(0,a.nI)(m.metadata.cameraMode)&&(v=-v),m.metadata.scanId===g.metadata.scanId){const t=n.B1.FORWARD.clone().applyQuaternion(this.cameraPose.rotation),e=n.B1.FORWARD.clone().applyQuaternion(g.metadata.cameraQuaternion),i=Math.sign(t.cross(e).y);v=0!==i?v*i:v}}this.adjustedPanSpeed=v,this.direction=Math.sign(v)}get active(){return null!==this.currentTransitionPromise}get promise(){return this.currentTransitionPromise?this.currentTransitionPromise:Promise.resolve()}async stop(){this.currentTransitionPromise&&(await this.onStopRequested(),await this.promise,this.currentTransitionPromise=null,this.stopped=Date.now())}start(){if(this.active)throw Error("Transition already active");const{options:t}=this;this.onStopRequested=async()=>{await this.stopRotating()};const e=t.nextSnapshot&&!(0,a.nI)(t.nextSnapshot.metadata.cameraMode),i=this.rotate(this.duration,new r.Vector2(this.adjustedPanSpeed,0),!e);return this.currentTransitionPromise=i.then((()=>{this.currentTransitionPromise=null,this.stopped=Date.now()})),this.started=Date.now(),this.stopped=-1,this}}},58499:(t,e,i)=>{i.d(e,{A:()=>H});var s=i(53172),o=i(86866),n=i(60152),r=i(88664),a=i(56208),h=i(90160),d=i(1333);class c{constructor(t=-1){this.active=!1,this.type=d.gX.Nop,this.promise=Promise.resolve(),this.stop=()=>Promise.resolve(),this.duration=0,this.started=-1,this.stopped=-1,this.toIndex=t}start(){return this}}var l=i(48539);class u{constructor(t,e){this.type=d.gX.Delay,this.toIndex=-1,this.started=-1,this.stopped=-1,this.duration=0,this.currentTransitionPromise=null,this.cancelDelay=()=>null,this.duration=t,this.toIndex=e}get active(){return null!==this.currentTransitionPromise}get promise(){return this.currentTransitionPromise?this.currentTransitionPromise:Promise.resolve()}async stop(){this.currentTransitionPromise&&(this.cancelDelay(),this.currentTransitionPromise=null,this.stopped=Date.now())}start(){if(this.active)throw Error("Transition already active");const t=(0,l.op)(this.duration);return this.cancelDelay=()=>{t.resolveEarly()},this.currentTransitionPromise=t.promise.then((()=>this.stop())),this.started=Date.now(),this.stopped=-1,this}}class p{constructor(t,e,i,s){this.zoom=i,this.stopZooming=s,this.type=d.gX.Zoom,this.toIndex=-1,this.started=-1,this.stopped=-1,this.duration=0,this.currentTransitionPromise=null,this.onStopRequested=()=>Promise.resolve(),this.duration=t.duration,this.toIndex=e}get active(){return null!==this.currentTransitionPromise}get promise(){return this.currentTransitionPromise?this.currentTransitionPromise:Promise.resolve()}async stop(){this.currentTransitionPromise&&(await this.onStopRequested(),await this.promise,this.currentTransitionPromise=null,this.stopped=Date.now())}start(){if(this.active)throw Error("Transition already active");return this.currentTransitionPromise=this.zoom(this.duration,-5).then((()=>{this.currentTransitionPromise=null,this.stopped=Date.now()})),this.started=Date.now(),this.stopped=-1,this.onStopRequested=async()=>{await this.stopZooming()},this}}var m=i(68909),g=i(81662),w=i(33007);class T{constructor(t,e,i,s,o){var n;this.options=t,this.settingsData=i,this.rotate=s,this.stopRotating=o,this.type=d.gX.Burns,this.toIndex=-1,this.started=-1,this.stopped=-1,this.duration=0,this.currentTransitionPromise=null,this.onStopRequested=()=>Promise.resolve(),this.toIndex=e,this.duration=null!==(n=t.duration)&&void 0!==n?n:H.getPanValues(this.settingsData,!1,t.panOverrides).ms}get active(){return null!==this.currentTransitionPromise}get promise(){return this.currentTransitionPromise?this.currentTransitionPromise:Promise.resolve()}async stop(){this.currentTransitionPromise&&(await this.onStopRequested(),await this.promise,this.currentTransitionPromise=null,this.stopped=Date.now())}start(){if(this.active)throw Error("Transition already active");const{options:t}=this;if(!t.snapshot||!t.nextSnapshot)return this.currentTransitionPromise=Promise.resolve(),this.started=Date.now(),this.stopped=Date.now(),this;const{deferred:e}=this.build(t.snapshot,t.nextSnapshot,t.panOverrides);return this.currentTransitionPromise=e.then((()=>{this.currentTransitionPromise=null,this.stopped=Date.now()})),this.started=Date.now(),this.stopped=-1,this}build(t,e,i){const s=H.getPanValues(this.settingsData,!1,i);let o=s.direction;void 0!==o&&o!==d.ND.Auto||(o=T.getAutoPanDirection(t,e)),this.onStopRequested=async()=>{await this.stopRotating()};return{deferred:this.rotate(this.duration,new m.Vector2(o*s.radiansPerMs,0))}}static getAutoPanDirection(t,e){let i=d.ND.Right;if(t&&t.metadata.scanId&&t.metadata.cameraQuaternion&&t.metadata.cameraPosition&&e&&e.metadata.scanId&&e.metadata.cameraPosition&&e.metadata.cameraQuaternion){const s=g.B1.FORWARD.clone().applyQuaternion(t.metadata.cameraQuaternion),o=e.metadata.cameraPosition,n=t.metadata.cameraPosition;let r=o.clone().sub(n).normalize();r.lengthSq()<w.A.epsilon&&(r=g.B1.FORWARD.clone().applyQuaternion(e.metadata.cameraQuaternion)),s.cross(r).y>0&&(i=d.ND.Left)}return i}}var v=i(79769),P=i(13893),y=i(94814),D=i(31093),f=i(48734);const S=.001,I=(t,e,i,s)=>{const o=Math.max(.75,Math.min(t.distanceTo(e),5)),n=o*(1/s)*1e3;let r=n;const a=i/n;if(a>S){r+=r*((a-S)/S)}const h=Math.abs(t.clone().setX(0).setZ(0).distanceTo(e.clone().setX(0).setZ(0))/Math.max(o,1));if(h>.1){r*=.9+.75*h}return r};class C extends d.Tz{constructor(t,e,i,s,o,n,r,a){super(),this.options=t,this.settingsData=i,this.cameraPose=s,this.moveToSweep=o,this.updateTransitionSpeed=n,this.setRestrictedSweeps=r,this.generators=a,this.toIndex=-1,this.started=-1,this.stopped=-1,this.duration=0,this.currentGenerator=null,this.currentTransitionPromise=null,this.type=d.gX.Move,this.toIndex=e,this.sweeps=t.path.slice(0,2)}get active(){return null!==this.currentTransitionPromise||null!==this.currentGenerator}get promise(){return this.currentTransitionPromise?this.currentTransitionPromise:Promise.resolve()}async stop(){this.currentTransitionPromise&&(await this.onStopRequested(),await this.promise,this.currentTransitionPromise=null,this.stopped=Date.now()),this.currentGenerator&&(this.generators.stopGenerator(this.currentGenerator),this.currentGenerator=null)}calculateCurve(){const{sweeps:[{position:t},{position:e}]}=this,i=t.distanceTo(e);return{curve:new m.LineCurve3(t,e),totalLength:i,normalSourceDistances:[0,1],sourceDistances:[0,i]}}start(){if(this.active)throw Error("Transition already active");const{options:t}=this,{generator:e,deferred:i}=this.build(t.path,t.orientations);return this.generators.startGenerator(e),this.currentGenerator=e,this.currentTransitionPromise=i.nativePromise(),this.started=Date.now(),this.stopped=-1,this}build(t,e){const i=new D.i,s=this;let n=!1;return this.onStopRequested=async()=>{n=!0,await this.updateTransitionSpeed(v.FAST_FORWARD_FACTOR)},{generator:function*(){let r=1;for(;r<t.length&&!n;){const i=r-1,n=t[r],a=n.position,h=t[i],d=e[r],c=(0,o.HN)(s.cameraPose.rotation,d),l=H.getTransitionSpeed(s.settingsData),u=I(h.position,a,c,l),p={transitionType:P.fl.Interpolate,sweepId:n.id,rotation:d,transitionTime:u,easing:y.p9};s.duration=u,s.setRestrictedSweeps(t,i);const m=s.moveToSweep(p);yield new f.sv(m.nativePromise()),r++}s.setRestrictedSweeps(null),i.resolve(),s.currentTransitionPromise=null,s.stop()},deferred:i}}}var M=i(39209);const x=new(i(10843).Ay)("tours");class b extends d.Tz{constructor(t,e,i,s,n,r,a,h,c,l,u){super(),this.options=t,this.cameraPose=s,this.cameraTransition=n,this.sweepTransition=r,this.sweepControl=a,this.cameraControl=h,this.generators=c,this.setRestrictedSweeps=l,this.getCurve=u,this.type=d.gX.Path,this.toIndex=-1,this.started=-1,this.stopped=-1,this.duration=0,this.speed=0,this.currentTransitionGenerator=null,this.currentTransitionPromise=null,this.canceling=!1,this.buildTransition=(t,e)=>{const i=this,s=new D.i,n=this.calculateCurve(),r=y.p9,a=y.rn,h=y.dV;i.cameraControl.beginExternalTransition();return{generator:function*(){s.notify(0);const d=new m.Vector3,c=new m.Quaternion;let l=0,u=0,p=0,g=1,w=t[g].id;yield new f.sv(i.sweepControl.activateSweepUnsafe({sweepId:w}).then((()=>{i.sweepControl.beginSweepTransition({sweepId:w,transitionTime:i.duration,internalProgress:!1})}))),t.length>2&&i.sweepControl.activateSweepUnsafe({sweepId:t[2].id});let T=i.cameraPose.rotation.clone();for(;l<i.duration&&!i.canceling;){const m=l/i.duration;p>0&&(T=e[p].clone());const v=e[g],P=n.normalSourceDistances[p],y=n.normalSourceDistances[g],D=t[g];if(u=(0,o.OF)(m,P,y,0,1),u<=1){const t=h(u,0,1,1);i.sweepTransition.progress.modifyAnimation(t,1,0);const e=a(u,0,1,1);c.copy(T).slerp(v,e)}m<1&&d.copy(n.curve.getPointAt(r(m,0,1,1))),i.cameraControl.updateCameraPosition(d),i.cameraControl.updateCameraRotation(c),m>=y&&(i.sweepControl.endSweepTransition({sweepId:D.id}),p++,g++,w=t[p+1].id,yield new f.sv(i.sweepControl.activateSweepUnsafe({sweepId:w}).then((()=>{i.sweepControl.beginSweepTransition({sweepId:w,transitionTime:i.duration,internalProgress:!1})}))),t.length>p+2&&i.sweepControl.activateSweepUnsafe({sweepId:t[p+2].id})),s.notify(m),l=Date.now()-i.cameraTransition.startTime,yield new f.oN}if(i.cameraControl.endExternalTransition(),i.canceling){i.canceling=!1;const e=t[g].position,s=I(i.cameraPose.position,e,0,i.speed),n=i.cameraControl.moveTo({transitionTime:s/v.FAST_FORWARD_FACTOR,transitionType:P.fl.Interpolate,pose:{position:e}});n.progress((t=>{const e=(0,o.OF)(t,0,1,u,1);i.sweepTransition.progress.modifyAnimation(e,1,0)})),yield new f.sv(n.nativePromise())}i.sweepControl.endSweepTransition({sweepId:w}),s.notify(1),s.resolve()},deferred:s}},this.toIndex=e,this.sweeps=t.path,this.speed=H.getTransitionSpeed(i),this.duration=((t,e,i)=>{let s=0;for(let n=0;n<t.length-1;n++){const r=(0,o.HN)(e[n],e[n+1]);s+=I(t[n].position,t[n+1].position,r,i)}return s})(t.path,t.orientations,this.speed),x.debug(`path duration: ${this.duration.toFixed(0)}ms, at speed: ${this.speed}m/s`)}get active(){return null!==this.currentTransitionPromise||null!==this.currentTransitionGenerator}get promise(){return this.currentTransitionPromise?this.currentTransitionPromise:Promise.resolve()}async stop(){this.canceling=!0,this.currentTransitionPromise&&(await this.promise,this.currentTransitionPromise=null,this.stopped=Date.now()),this.currentTransitionGenerator&&(this.generators.stopGenerator(this.currentTransitionGenerator),this.currentTransitionGenerator=null)}start(){const{options:t}=this;if(x.debug(`starting smooth transition with ${t.path.length-1} stops`),this.active)throw Error("Transition already active");this.canceling=!1;const{generator:e,deferred:i}=this.buildTransition(t.path,t.orientations);return this.generators.startGenerator(e),this.currentTransitionGenerator=e,this.currentTransitionPromise=i.nativePromise().then((()=>{this.currentTransitionPromise=null,this.currentTransitionGenerator=null,this.stopped=Date.now()})),this.started=Date.now(),this.stopped=-1,this}calculateCurve(){const t=this.options.path;if(t.length<=2)throw x.debug(`invalid path: ${t}`),new Error("smooth path requires more than 2 stops");this.setRestrictedSweeps(t);const e=t.map((t=>t.position)),i=this.getCurve(e);return this.setRestrictedSweeps(null),i}}var R=i(2993);class F{constructor(t,e,i,s,o,n,r,a,h,c){this.options=t,this.settingsData=i,this.cameraPose=s,this.viewmodeData=o,this.cameraControl=n,this.sweepControl=r,this.switchToMode=a,this.setRestrictedSweeps=h,this.generators=c,this.toIndex=-1,this.started=-1,this.stopped=-1,this.duration=0,this.type=d.gX.Move,this.currentTransitionPromise=null,this.onStopRequested=()=>Promise.resolve(),this.toIndex=e}get active(){return null!==this.currentTransitionPromise}get promise(){return this.currentTransitionPromise?this.currentTransitionPromise:Promise.resolve()}async stop(){this.currentTransitionPromise&&(await this.onStopRequested(),await this.promise,this.currentTransitionPromise=null,this.stopped=Date.now())}start(){if(this.active)throw Error("Transition already active");const t=this.options;if(!t.snapshot)return this.currentTransitionPromise=Promise.resolve(),this;const{deferred:e}=this.build(t.snapshot,t.currentSweep,t.transitionType);return this.currentTransitionPromise=e.then((()=>{this.currentTransitionPromise=null,this.stopped=Date.now()})),this.started=Date.now(),this.stopped=-1,this}build(t,e,i){var s,n,r;let a=Promise.resolve();const h=t.metadata.cameraMode,d=t.metadata.cameraQuaternion;let c,l;if(t.metadata.scanId){const e=this.sweepControl.getSweepOnView(t.metadata.scanId,null!==(s=t.sourceViewId)&&void 0!==s?s:null);c=null==e?void 0:e.id,l=null==e?void 0:e.platformId}const u=this.cameraPose.rotation,p=(0,o.HN)(u,d),m=t.metadata.cameraPosition,g=!t.is360,w={position:m,rotation:d,sweepID:c,zoom:t.metadata.orthoZoom};let T=H.getOtherModeTransitionTime(this.settingsData,p,i);const v=this.viewmodeData.isDollhouse()&&!this.cameraPose.isPitchFactorOrtho,y=this.viewmodeData.isFloorplan()||this.cameraPose.isPitchFactorOrtho,D=h===R.N3.Floorplan;if(h===R.N3.Dollhouse&&!v||D&&!y||h!==this.viewmodeData.currentMode)a=this.switchToMode(h,i,w,T);else{if(!!c&&this.viewmodeData.isInside()){if(c){const s=e&&(null===(n=this.sweepControl.data.currentSweepObject)||void 0===n?void 0:n.platformId)===l,o=((null===(r=this.sweepControl.data.currentSweepObject)||void 0===r?void 0:r.sourceViewId)||null)!==(t.sourceViewId||null),h=!e||c!==e;s?(T=H.getSamePanoTransitionTime(this.settingsData,p),a=o?this.standardSweepMovePromise({rotation:w.rotation,targetSweepId:c,transitionTime:T,transitionType:P.fl.Interpolate,viewId:t.sourceViewId}):this.standardTransitionSameSweepRotationPromise(w.rotation,c,p,T,t.sourceViewId)):h&&(T=H.getTransitionTime(this.settingsData),a=t.is360?this.standardSweepMovePromise({rotation:w.rotation,targetSweepId:c,transitionTime:T,transitionType:i,viewId:t.sourceViewId}):this.standardTransitionSweepMovePromise(w,c,g,T))}}else a=this.cameraControl.moveTo({transitionType:i,pose:w,transitionTime:T}).nativePromise()}return this.duration=null!=T?T:0,{deferred:a}}standardTransitionSameSweepRotationPromise(t,e,i,s,o){var n;return this.setRestrictedSweeps(null),(null===(n=this.sweepControl.data.currentSweepObject)||void 0===n?void 0:n.id)!==e?this.sweepControl.moveToSweep({sweepId:e,viewId:null!=o?o:null,transitionTime:s,transitionType:P.fl.Interpolate,rotation:t}).nativePromise():i<.01?Promise.resolve():this.cameraControl.moveTo({transitionType:P.fl.Interpolate,pose:{rotation:t},transitionTime:s}).nativePromise()}standardSweepMovePromise({rotation:t,targetSweepId:e,transitionTime:i,transitionType:s,viewId:o}){return this.sweepControl.moveToSweep({rotation:t,sweepId:e,transitionTime:i,transitionType:s,viewId:null!=o?o:null}).nativePromise()}standardTransitionSweepMovePromise(t,e,i,s){if(!t.position)throw Error("Push transition requires a position");const o=t.position.clone().sub(this.cameraPose.position).normalize(),n=this.cameraPose.position.clone().add(o.multiplyScalar(.15)),r=new D.i;this.setRestrictedSweeps(null);const a=this;return this.generators.startGenerator((function*(){yield new f.sv(a.sweepControl.activateSweepUnsafe({sweepId:e}));const o=new m.Vector3,h=a.cameraPose.position.clone(),d=Date.now();let c,l=0,u=!1,p=!1;for(;l<s;){const r=(0,y.Do)(l,0,l/s,s);i&&a.cameraControl.updateCameraPosition(o.copy(h).lerp(n,r)),r>=.3&&!p&&(c=a.cameraControl.moveTo({transitionType:P.fl.FadeToBlack,pose:t,transitionTime:s,blackoutTime:.5*s}).progress((t=>{t>=.5&&!u&&(a.sweepControl.instantSweepTransition(e),u=!0)})),p=!0),yield new f.oN,l=Date.now()-d}c&&(yield new f.sv(c.nativePromise())),r.resolve()})),r.nativePromise()}}class V{constructor(t,e,i,s,o,n){this.options=t,this.moveToSweep=i,this.viewmodeData=s,this.cameraControl=o,this.switchToMode=n,this.toIndex=-1,this.started=-1,this.stopped=-1,this.duration=0,this.type=d.gX.Move,this.currentTransitionPromise=null,this.onStopRequested=()=>Promise.resolve(),this.toIndex=e}get active(){return null!==this.currentTransitionPromise}get promise(){return this.currentTransitionPromise?this.currentTransitionPromise:Promise.resolve()}async stop(){this.currentTransitionPromise&&(await this.onStopRequested(),await this.promise,this.currentTransitionPromise=null,this.stopped=Date.now())}start(){if(this.active)throw Error("Transition already active");const{options:t}=this;if(!t.snapshot)return this.currentTransitionPromise=Promise.resolve(),this.started=Date.now(),this.stopped=Date.now(),this;const{deferred:e}=this.build(t.snapshot,t.currentSweep);return this.currentTransitionPromise=e.then((()=>{this.currentTransitionPromise=null,this.stopped=Date.now()})),this.started=Date.now(),this.stopped=-1,this}build(t,e){let i=Promise.resolve();const s=t.metadata.cameraMode,o=t.metadata.cameraQuaternion,n=t.metadata.scanId,r={position:t.metadata.cameraPosition,rotation:o,sweepID:n,zoom:t.metadata.orthoZoom},a=s!==this.viewmodeData.currentMode,h=!!n&&this.viewmodeData.isInside();if(a)i=this.switchToMode(s,P.fl.Instant,r);else if(h){const t={transitionType:P.fl.Instant,sweepId:n,rotation:o};i=this.moveToSweep(t).nativePromise()}else i=this.cameraControl.moveTo({transitionType:P.fl.Instant,pose:r}).nativePromise();return{deferred:i}}}var A=i(72773),O=i(23272);class N{constructor(t,e,i,s){this.targetSnapshot=t,this.issueCommand=i,this.currentFloorId=s,this.type=d.gX.FloorChange,this.toIndex=-1,this.started=-1,this.stopped=-1,this.duration=A.t$,this.currentTransitionPromise=null,this.onStopRequested=()=>Promise.resolve(),this.toIndex=e}get active(){return null!==this.currentTransitionPromise}get promise(){return this.currentTransitionPromise?this.currentTransitionPromise:Promise.resolve()}async stop(){this.currentTransitionPromise&&(await this.onStopRequested(),await this.promise,this.currentTransitionPromise=null,this.stopped=Date.now())}start(){if(this.active)throw Error("Transition already active");let t=Promise.resolve();const e=this.targetSnapshot.metadata.floorId,i=e!==this.currentFloorId(),s=this.targetSnapshot.metadata.cameraMode;return!(0,R.nI)(s)&&s!==R.N3.Outdoor&&i&&(t=this.issueCommand(new O.i1(e,!0,this.duration))),this.currentTransitionPromise=t.then((()=>{this.currentTransitionPromise=null,this.stopped=Date.now()})),this.started=Date.now(),this.stopped=-1,this}}class E{constructor(t,e,i,s,o){var n;this.options=t,this.settingsData=i,this.rotate=s,this.stopRotating=o,this.type=d.gX.Burns,this.toIndex=-1,this.started=-1,this.stopped=-1,this.duration=0,this.currentTransitionPromise=null,this.onStopRequested=()=>Promise.resolve(),this.toIndex=e,this.duration=null!==(n=t.duration)&&void 0!==n?n:H.getPanValues(this.settingsData,!0,t.panOverrides).ms}get active(){return null!==this.currentTransitionPromise}get promise(){return this.currentTransitionPromise?this.currentTransitionPromise:Promise.resolve()}async stop(){this.currentTransitionPromise&&(await this.onStopRequested(),await this.promise,this.currentTransitionPromise=null,this.stopped=Date.now())}start(){if(this.active)throw Error("Transition already active");const{options:t}=this;if(!t.snapshot||!t.nextSnapshot)return this.currentTransitionPromise=Promise.resolve(),this;const{deferred:e}=this.build(t.snapshot,t.nextSnapshot,t.panOverrides);return this.currentTransitionPromise=e.then((()=>{this.currentTransitionPromise=null,this.stopped=Date.now()})),this.started=Date.now(),this.stopped=-1,this}build(t,e,i){const s=H.getPanValues(this.settingsData,!0,i);let o=-1*s.radiansPerMs;const n=s.direction;if(void 0!==n&&n!==d.ND.Auto)o*=n;else if(t&&t.metadata.cameraQuaternion&&e&&e.metadata.cameraQuaternion){const i=g.B1.FORWARD.clone().applyQuaternion(t.metadata.cameraQuaternion),s=g.B1.FORWARD.clone().applyQuaternion(e.metadata.cameraQuaternion),n=Math.sign(i.cross(s).y);o=0!==n?o*n:o}this.onStopRequested=async()=>{await this.stopRotating()};return{deferred:this.rotate(this.duration,new m.Vector2(o,0))}}}var G=i(3680);const B={sharpTurnDotThreshold:.65,directionWeightFactorStd:.75,directionWeightFactorSharp:.2,positionalWeightFactorStd:.4,positionalWeightFactorSharp:.2,finalWalkingNodeDirectionWeight:5,lookAheadNodes:3};class k{constructor(t=B){this.settings=t}getOrientationsForPath(t,e){const i=[];for(let s=0;s<t.length;s++){const o=new m.Vector3;this.getLookVectorsForPathNode(t,s,e,o);const n=(new m.Matrix4).lookAt(t[s],o,g.B1.UP);i[s]=(new m.Quaternion).setFromRotationMatrix(n)}return i.push(e),i}getLookVectorsForPathNode(t,e,i,s){const o=new m.Vector3,n=new m.Vector3,r=new m.Vector3,a=new m.Vector3,h=t.length;if(e>=h)return!1;let d=1,c=1;const l=new m.Vector3;let u;for(let s=e;s<e+this.settings.lookAheadNodes&&s<h;s++){if(u=t[s],this.getOrientationForPathNode(t,s,i,r),s===e&&o.copy(r),s>e){const t=o.dot(r)<this.settings.sharpTurnDotThreshold;d*=t?this.settings.directionWeightFactorSharp:this.settings.directionWeightFactorStd,c*=t?this.settings.positionalWeightFactorSharp:this.settings.positionalWeightFactorStd}s===h-1&&(d=this.settings.finalWalkingNodeDirectionWeight,c=1),l.copy(r),r.multiplyScalar(d),n.add(r),a.lerp(u,c)}return n.normalize(),s.copy(a),s.add(n),!0}getOrientationForPathNode(t,e,i,s){if(e>=t.length)return!1;if(e===t.length-1)s.copy(g.B1.FORWARD).applyQuaternion(i);else{const i=t[e],o=t[e+1];s.copy(o).sub(i)}return s.normalize(),!0}}var W=i(71687);class L{constructor(t,e,i,s){this.sweepModule=t,this.pathModule=e,this.tourData=i,this.viewmodeData=s,this.getValidWalkingPath=t=>{var e,i;const s=null===(e=this.sweepModule.data.currentSweepObject)||void 0===e?void 0:e.platformId;let o;t.metadata.scanId&&(o=null===(i=this.sweepModule.data.getSweep(t.metadata.scanId))||void 0===i?void 0:i.platformId);let r=null;const a=this.tourData.getTourCurrentSnapshotSid();if(a){const t=this.tourData.getTourEntry(a);r=(null==t?void 0:t.snapshot)||null}if(!r||this.viewmodeData.currentMode!==R.N3.Panorama||!s||!o||s===o||r.is360||t.is360)return null;const h=this.pathModule.findShortestPath(s,o,n.W0.maxSweepDistance,n.W0.maxDistanceBeforeAddingSweeps,n.W0.minSweepDistance,n.W0.maxSidestepDistance,n.W0.pathRadius,n.W0.maxTotalSteps)||[];if(0===h.length)return null;if(t.sourceViewId||r.sourceViewId){const e=[];for(const i of h)0===e.length?e.push(this.sweepModule.getSweepOnView(i.platformId,r.sourceViewId)):e.push(this.sweepModule.getSweepOnView(i.platformId,t.sourceViewId));return e}return h}}}var Q=i(44481),$=i(35447);class H{constructor(t,e,i,s,o,n){this.engine=t,this.tourData=e,this.sweepModule=i,this.cameraData=s,this.settingsData=o,this.viewmodeData=n,this.init=async()=>{this.sweepData=this.sweepModule.data,this.cameraPoseController=await this.engine.getModuleBySymbol(W.jh),this.pathModule=await this.engine.getModuleBySymbol(W.Np),this.floorsViewData=await this.engine.market.waitForData(M.X),this.toursViewData=await this.engine.market.waitForData(Q.F),this.commonControlsModule=await this.engine.getModuleBySymbol(W.X7),this.viewmodeModule=await this.engine.getModuleBySymbol(W.SD),this.pathOrientHelper=new k,this.setRestrictedSweeps=this.pathModule.setRestrictedSweeps.bind(this.pathModule),this.getCurveForPath=this.pathModule.getCurveForPath.bind(this.pathModule),this.moveToSweep=this.sweepModule.moveToSweep.bind(this.sweepModule),this.updateTransitionSpeed=this.cameraPoseController.updateTransitionSpeed.bind(this.cameraPoseController),this.switchToMode=this.viewmodeModule.switchToMode.bind(this.viewmodeModule),this.startRotateTransition=this.commonControlsModule.startRotateTransition.bind(this.commonControlsModule),this.stopCamera=this.commonControlsModule.stop.bind(this.commonControlsModule),this.startZoomTransition=this.commonControlsModule.startZoomTransition.bind(this.commonControlsModule),this.issueCommand=this.engine.commandBinder.issueCommand.bind(this.engine.commandBinder),this.walkingPath=new L(this.sweepModule,this.pathModule,this.tourData,this.viewmodeData)}}static isDelayTransition(t,e,i){return!(0,n.ht)(t)||e!==d._y.Zoom&&0===H.getPanDegrees(t,i.panAngle)}getBurnsStyleForSnapshot(t){const{tourData:e}=this,i=e.getTourEntrySidFromIndex(t),s=e.getTourEntry(i),o=e.getHighlightsCount();if(!s||!s.snapshot)return d._y.None;if(t===o-1&&this.isStaticFinalStop(t))return this.toursViewData.getTourStoryMode()?d._y.Delay:d._y.None;const n=s.snapshot.metadata.cameraMode,r=n===R.N3.Dollhouse?d._y.PanDollhouse:n===R.N3.Floorplan?d._y.Zoom:d._y.Pan;return H.isDelayTransition(this.settingsData,r,s.overrides||{})?d._y.Delay:r}isStaticFinalStop(t){if(t<this.tourData.getHighlightsCount()-1)return!1;const{overrides:e}=this.tourData.getReel().reel.get(t),i=H.getPanDirection(this.settingsData,null==e?void 0:e.panDirection),s=H.getPanDegrees(this.settingsData,null==e?void 0:e.panAngle),o=this.tourData.getActiveReelTourMode(),n=(0,$.Kl)(this.settingsData,o);return 0===s||!n&&i===d.ND.Auto}static getPanDegrees(t,e){let i;return i=(0,n.ht)(t)?-1!==t.getOverrideParam(n.I5,-1)?(0,n.H1)(t):void 0!==e?e:t.tryGetProperty(a.Q$.PanAngle,n.V4):0,Math.max(i,0)}static getPanDirection(t,e){return void 0!==e?e:t.tryGetProperty(a.Q$.PanDirection,r.ek)}static getDelayDuration(t){return-1!==t.getOverrideParam(n.R8,-1)||0===t.getOverrideParam(n.Yh,-1)?(0,n.Lh)(t):n.DE}static getZoomDuration(t){return-1!==t.getOverrideParam(n.R8,-1)?(0,n.Lh)(t):t.tryGetProperty(a.Q$.ZoomDuration,n.cS)}static getPanRadiansPerMs(t,e,i,s){if(void 0===s&&-1!==t.getOverrideParam(n.R8,-1)&&(s=(0,n.Lh)(t)),void 0!==s)return s>0?i/s:0;const o=e?t.tryGetProperty(a.Q$.DollhousePanSpeed,n.lo):t.tryGetProperty(a.Q$.PanSpeed,n.BU);return(0,h.rX)(o)}static getPanValues(t,e,{panDirection:i,panAngle:o,panDuration:r}={}){const a=H.getPanDirection(t,i),h=H.getPanDegrees(t,o),d=(0,s.pu)(h),c=H.getPanRadiansPerMs(t,e,d,r);let l=c>0?d/c:0;return e&&void 0===o&&(l=(0,n.Lh)(t)),{degrees:h,radiansPerMs:c,ms:l,direction:a}}static getTransitionSpeed(t){if(-1!==t.getOverrideParam("wts",-1))return t.tryGetProperty(n._V,n.aS);const e=t.tryGetProperty(a.Q$.TransitionSpeed,n.Dj);return(0,h.f7)(e/1e3)}static getTransitionTime(t){const e=t.tryGetProperty(a.Q$.TransitionTime,n.VD);return Math.min(Math.max(n.K1,e),n.s$)}static getOtherModeTransitionTime(t,e,i){if(i===P.fl.FadeToBlack){return H.getTransitionTime(t)+n.IT}let o=n.BS,r=n.uO;if(-1===t.getOverrideParam("wts",-1)){const e=1e3*H.getTransitionSpeed(t);o=Math.sqrt(2*(e-n.g$))+45,e!==n.Dj&&(r=n.Jb)}const a=1e3*e/(s.fy*o);return Math.max(a,r)}static getSamePanoTransitionTime(t,e){const i=t.tryGetProperty(a.Q$.PanSpeed,n.BU);if(i===n.BU)return Math.max(1e3*e/(s.fy*n.Md),n.fi);{const t=(0,o.m9)(i,n.Ih,n.at,n.mf,n.QR),s=(0,h.rX)(t);return s>0?e/s:0}}getFloorTransition(t){var e;const i=this.tourData.getTourEntrySidFromIndex(t),s=null===(e=this.tourData.getTourEntry(i))||void 0===e?void 0:e.snapshot;if(!s){return new c(t)}return new N(s,t,this.issueCommand,(()=>this.floorsViewData.currentFloorId))}getMainTransition(t,e){var i;const s=this.tourData.getTourEntrySidFromIndex(t),n=null===(i=this.tourData.getTourEntry(s))||void 0===i?void 0:i.snapshot;if(!n){return new c(t)}let r=null;if(e===P.fl.Interpolate){const e=n.metadata.cameraQuaternion,i=this.walkingPath.getValidWalkingPath(n);if(i){const s=i.map((t=>t.position)),n=this.pathOrientHelper.getOrientationsForPath(s,(0,o.V5)(e));r=i.length>2?new b({path:i,orientations:n},t,this.settingsData,this.cameraData.pose,this.cameraData.transition,this.sweepData.transition,this.sweepModule,this.cameraPoseController,this.engine,this.setRestrictedSweeps,this.getCurveForPath):new C({path:i,orientations:n},t,this.settingsData,this.cameraData.pose,this.moveToSweep,this.updateTransitionSpeed,this.setRestrictedSweeps,this.engine)}}else if(e===P.fl.Instant){const e=this.sweepData.currentSweep;r=new V({snapshot:n,currentSweep:e},t,this.moveToSweep,this.viewmodeData,this.cameraPoseController,this.switchToMode)}if(!r){const i=this.sweepData.currentSweep;r=new F({snapshot:n,currentSweep:i,transitionType:e},t,this.settingsData,this.cameraData.pose,this.viewmodeData,this.cameraPoseController,this.sweepModule,this.switchToMode,this.setRestrictedSweeps,this.engine)}return r}getBurnsTransition(t,e=this.getBurnsStyleForSnapshot(t),i){var s,o;const n=this.tourData.getTourEntrySidFromIndex(t),r=(t+1)%this.tourData.getHighlightsCount(),a=this.tourData.getTourEntrySidFromIndex(r),h=this.tourData.getTourEntry(n);if(!h){return new c(t)}const l=h.snapshot,m={};h.overrides&&(m.panDirection=h.overrides.panDirection,m.panAngle=h.overrides.panAngle,m.panDuration=h.overrides.panDuration);const g=(null===(s=this.tourData.getTourEntry(a))||void 0===s?void 0:s.snapshot)||null;let w=new c(t);switch(e){case d._y.Pan:if(g){const e=this.walkingPath.getValidWalkingPath(g);w=new G.e({path:e,snapshot:l,nextSnapshot:g,panOverrides:m,duration:i},t,this.settingsData,this.cameraData.pose,this.startRotateTransition,this.stopCamera,this.getCurveForPath)}w.type===d.gX.Nop&&(w=new T({snapshot:h.snapshot,nextSnapshot:g,panOverrides:m,duration:i},t,this.settingsData,this.startRotateTransition,this.stopCamera));break;case d._y.PanDollhouse:w=new E({snapshot:l,nextSnapshot:g,panOverrides:m,duration:i},t,this.settingsData,this.startRotateTransition,this.stopCamera);break;case d._y.Zoom:w=new p({duration:null!==(o=null!=i?i:m.panDuration)&&void 0!==o?o:H.getZoomDuration(this.settingsData)},t,this.startZoomTransition,this.stopCamera);break;case d._y.Delay:w=new u(null!=i?i:H.getDelayDuration(this.settingsData),t);break;case d._y.None:w=new c(t);break;default:throw Error("unhandled TourBurnsStyle")}return w}}},79769:(t,e,i)=>{i.r(e),i.d(e,{FAST_FORWARD_FACTOR:()=>b,default:()=>R});var s=i(48734),o=i(60152),n=i(75578),r=i(2993),a=i(96425),h=i(21875),d=i(44481),c=i(99583),l=i(13893),u=i(22937),p=i(78079),m=i(44667),g=i(27947),w=i(22585),T=i(25316),v=i(20599),P=i(58499),y=i(1333),D=i(88664),f=i(8333),S=i(68930),I=i(71687),C=i(35447),M=i(47737),x=i(10843);const b=5;class R extends n.n{constructor(){super(...arguments),this.name="tours-controls",this.canChangeTourLocation=()=>{const t=this.data.getTourState(),e=this.data.isTourTransitionActive(),i=this.cameraData.canTransition();return t===a.Ci.Inactive&&!e&&!(this.viewmodeData.transition&&this.viewmodeData.transition.active)&&i}}async init(t,e){this.engine=e,[this.cameraData,this.viewmodeData,this.settingsData,this.data,this.toursViewData]=await Promise.all([e.market.waitForData(v.M),e.market.waitForData(c.X),e.market.waitForData(T.o),e.market.waitForData(h.R),e.market.waitForData(d.F)]);const i=await e.market.waitForData(M.P),s=await e.getModuleBySymbol(I.Wh);e.getModuleBySymbol(I.mL).then((t=>{t.registerHandler(p.CD,(()=>{this.handleTourInputInterrupt()})),t.registerHandler(m.s,(()=>{this.handleTourInputInterrupt()}))})),this.transitionFactory=new P.A(e,this.data,s,this.cameraData,this.settingsData,this.viewmodeData),await this.transitionFactory.init(),this.setupAutoPlay(e),this.bindings.push(i.onPropertyChanged("currentViewId",(()=>this.stopTour())))}handleTourInputInterrupt(){this.data.getTourState()!==a.Ci.Inactive&&this.stopTour()}canTourProceed(t,e,i){const s=this.data.getHighlightsCount();if(0===s||0===i||this.data.getTourState()!==a.Ci.Inactive)return!1;if(void 0!==e){if(e<-1)return!1;if(!0!==t&&e>s-1)return!1}return!0}shouldTourContinue(t,e,i,s){return void 0!==s?i<s:e<t-1}startTour({index:t,steps:e,loop:i}={}){if(!this.canChangeTourLocation())throw new S.r("Cannot start tour at this time, another transition is active");const o=void 0!==i?i:this.data.isLooping();if(!this.canTourProceed(o,t,e))return;this.data.setLooping(o);const n=this.data.getActiveReelTourMode(),r=(0,C.Kl)(this.settingsData,n),h=this.data.getTourCurrentSnapshotIndex(),d=this.data.getHighlightsCount(),c=this.data.transition,l=h===d-1&&(y.h9.includes(c.type)||!r)&&c.toIndex===d-1&&c.stopped-c.started>=c.duration;let p,m=0;p=void 0!==t?t-1:l?-1:Math.max(h-1,-1);const g=this.settingsData.tryGetProperty(f.Oe,null);this.settingsData.setProperty(f.Oe,null);const w=this;this.tourGenerator=function*(){for(;w.shouldTourContinue(d,p,m,e);){const t=p+1,e=w.composeTourTransition(t);yield new s.sv(e),p=t,p===d-1&&o&&(p=-1),m++}w.stopTour(),w.settingsData.setProperty(f.Oe,g)},this.engine.startGenerator(this.tourGenerator),this.data.setTourState(a.Ci.Active),this.data.tourEnded=!1,this.data.tourWillResume=!1,this.data.tourPlaying=!0,this.data.commit(),this.engine.broadcast(new u.zM)}async composeTourTransition(t,e,i){var s;const n=this.data.getTourEntrySidFromIndex(t),h=this.data.getTourEntry(n);if(!h||!h.snapshot)throw Error(`Highlight not found for reel index ${t}`);const d=this.data.getTourCurrentSnapshotSid()===n,c=this.cameraData.transition.startTime>this.data.transition.stopped;let p=0;const m=this.data.transition.duration;if(d){const{started:t,stopped:e}=this.data.transition;p=(e-t)/m||0,p=Math.min(1,p)}if(c||!d){let e=this.settingsData.tryGetProperty(D.zk,l.fl.Interpolate);const o=h.snapshot.metadata.cameraMode,n=o===r.N3.Dollhouse||o===r.N3.Floorplan,d=(0,r.nI)(o),c=!this.viewmodeData.isInside()&&d,p=this.viewmodeData.isInside()&&n,m=!this.viewmodeData.isInside()&&n,g=this.viewmodeData.isInside()&&d;(c||p||m)&&(e=l.fl.Interpolate),void 0!==(null===(s=null==h?void 0:h.overrides)||void 0===s?void 0:s.transitionType)&&(e=h.overrides.transitionType),g&&0===t&&(e=l.fl.FadeToBlack),void 0!==i&&(e=i),this.engine.broadcast(new u.zb(t));const w=this.transitionFactory.getFloorTransition(t).start();if(this.data.useTransition(w),await w.promise,this.data.getTourState()===a.Ci.StopScheduled)return;const T=this.transitionFactory.getMainTransition(t,e).start();this.data.useTransition(T),await T.promise,this.data.setTourCurrentSnapshotByIndex(t),this.engine.broadcast(new u.n1(t))}if(this.data.getTourState()===a.Ci.StopScheduled)return;let g;this.toursViewData.getTourStoryMode()&&this.transitionFactory.isStaticFinalStop(t)&&(g=o.Dw),p>0&&(g=(1-p)*m);const w=this.transitionFactory.getBurnsTransition(t,e,g).start();this.engine.broadcast(new u.BW(t,w.type,w.duration)),this.data.useTransition(w),await w.promise}async stopTour({willResume:t=!1}={}){this.data.getTourState()===a.Ci.Active&&(this.data.setTourState(a.Ci.StopScheduled),this.data.tourWillResume=t,this.data.tourPlaying=!1,await this.data.stopTourTransition(),this.tourGenerator&&this.engine.stopGenerator(this.tourGenerator),this.engine.broadcast(new u.pT(t)),this.data.getTourCurrentSnapshotIndex()!==this.data.getHighlightsCount()-1||this.data.isLooping()||(this.data.tourEnded=!0,this.engine.broadcast(new u.YH)),this.data.setTourState(a.Ci.Inactive),this.data.commit())}async tourGoNext(t){let e=this.data.getTourCurrentSnapshotIndex()+1;return e>=this.data.getHighlightsCount()&&(e=0),this.tourGoTo(e,t)}async tourGoPrevious(t){let e=this.data.getTourCurrentSnapshotIndex();e<0&&(e=0);let i=e-1;return i<0&&(i=this.data.getHighlightsCount()-1),this.tourGoTo(i,t)}async tourGoTo(t,{transitionType:e=l.fl.FadeToBlack,instant:i,resumeIfPlaying:s=!1}={}){if(this.viewmodeData.transition&&this.viewmodeData.transition.active)throw new S.K("Cannot go to tour location during viewmode transition");const o=this.data.tourPlaying;o&&await this.stopTour({willResume:s});try{this.data.setTourState(a.Ci.Active),await this.composeTourTransition(t,y._y.None,i?l.fl.Instant:e)}catch(t){x.Ay.for(this).error(t)}finally{this.data.setTourState(a.Ci.Inactive)}s&&o&&this.startTour()}setupAutoPlay(t){const e=1e3*(0,o.dJ)(this.settingsData),i=()=>{let t=!0;const i=this.cameraData.pose.onChanged((()=>{t=!1,i.cancel()}));setTimeout((()=>{t&&this.startTour(),i.cancel()}),e)};if(e>=0){const e=t.market.tryGetData(g.zH);if(e&&e.phase===g.Jj.PLAYING)i();else{const e=s=>{s.phase===g.Jj.PLAYING&&(i(),t.unsubscribe(w.uv,e))};t.subscribe(w.uv,e)}}}}},52947:(t,e,i)=>{i.d(e,{Ay:()=>n,F7:()=>a,cF:()=>r});var s=i(68909);class o{constructor(t,e){this.raycast=(()=>{const t=new s.Vector3,e=new s.Box3;return(i,s,n,h)=>{const d=e.copy(this.bounds).expandByScalar(s);if(i.ray.intersectsBox(d))for(const e of this.children)if(e instanceof o)e.raycast(i,s,n,h);else if(e instanceof r){if(!1===(null==h?void 0:h(e)))continue;const o=t,r=i.ray.distanceSqToSegment(e.start,e.end,void 0,t),a=Math.sqrt(r);a<s&&n.push({distance:i.ray.origin.distanceTo(o),object:e,distanceToRay:a,point:o.clone(),isLineOctreeIntersection:!0})}else if(e instanceof a){if(!1===(null==h?void 0:h(e)))continue;const t=i.ray.distanceToPoint(e);t<s&&n.push({distance:i.ray.origin.distanceTo(e),object:e,distanceToRay:t,point:e.clone(),isLineOctreeIntersection:!0})}}})(),this.level=e,this.bounds=t.clone(),this.clear()}clear(){this.childNodes=[],this.children=[]}add(t){let e=!1;const i=t instanceof s.Line3?[t.start,t.end]:[t];if(this.level<4){0===this.childNodes.length&&this.buildChildNodes();for(const s of this.childNodes)i.every((t=>s.bounds.containsPoint(t)))&&(e=!0,s.add(t))}e||this.children.push(t)}remove(t){const e=t instanceof s.Line3?[t.start,t.end]:[t];for(let i=0;i<this.children.length;i++){const s=this.children[i];if(s instanceof o){if(e.every((t=>s.bounds.containsPoint(t)))&&s.remove(t))return!0}else if(s===t)return this.children.splice(i,1),!0}return!1}buildChildNodes(){const t=this.bounds.max.clone().sub(this.bounds.min).clone().multiplyScalar(.5);for(let e=0;e<2;e++)for(let i=0;i<2;i++)for(let n=0;n<2;n++){const r=this.bounds.min.x+t.x*n,a=r+t.x,h=this.bounds.min.y+t.y*e,d=h+t.y,c=this.bounds.min.z+t.z*i,l=c+t.z,u=new s.Box3(new s.Vector3(r,h,c),new s.Vector3(a,d,l)),p=new o(u,this.level+1);this.childNodes.push(p),this.children.push(p)}}spherecast(t,e){if(t.intersectsBox(this.bounds))for(const i of this.children)if(i instanceof o)i.spherecast(t,e);else if(i instanceof r){const o=i.closestPointToPoint(t.center,!0,new s.Vector3);o.distanceTo(t.center)<t.radius&&e.push(new a(o))}else i instanceof s.Vector3&&i.distanceTo(t.center)<t.radius&&e.push(i)}traverse(t){for(const e of this.children)e instanceof o?e.traverse(t):t(e)}}class n{constructor(t){this.pointCount=0,this.lineCount=0,this.root=new o(t,0)}add(t){t instanceof s.Line3?this.lineCount++:t instanceof s.Vector3&&this.pointCount++,this.root.add(t)}remove(t){t instanceof r?this.lineCount--:t instanceof a&&this.pointCount--,this.root.remove(t)}clear(){this.root.clear(),this.pointCount=0,this.lineCount=0}traverse(t){this.root.traverse(t)}raycast(t,e,i){const s=[];return this.root.raycast(t,e,s,i),s}}class r extends s.Line3{constructor(t,e){super(t,e),this.start=t,this.end=e,this.isSnapLine3=!0}copy(t){return this.start.copy(t.start),this.end.copy(t.end),this}clone(){return new r(this.start,this.end)}}class a extends s.Vector3{constructor(t){super(),this.point=t,this.isSnapVector3=!0,super.copy(t)}copy(t){return this.point.copy(t.point),this}clone(){return new a(this.point)}}},23987:(t,e,i)=>{i.d(e,{Z:()=>s});const s=new class{constructor(t=!0){this.values=new Map,t&&this.show()}clear(){this.values.clear(),this.drawValues()}show(){if(this.debugDiv)return;this.debugDiv=document.createElement("div");const t=this.debugDiv.style;t.fontFamily="monospace",t.position="fixed",t.backgroundColor="#aa11aa",t.left="20px",t.top="20px",t.zIndex="999899",t.pointerEvents="none",t.touchAction="none",document.body.appendChild(this.debugDiv),this.drawValues()}hide(){this.debugDiv&&(document.body.removeChild(this.debugDiv),this.debugDiv=void 0)}logValue(t,e){this.values.set(t,e),this.drawValues()}logMaxValue(t,e){this.values.has(t)?e>this.values.get(t)&&this.logValue(t,e):this.logValue(t,e)}logVector2(t,e){this.logValue(t,`(${e.x}, ${e.y})`)}logVector3(t,e){this.logValue(t,`(${e.x}, ${e.y}, ${e.z})`)}logVector4(t,e){this.logValue(t,`(${e.x}, ${e.y}, ${e.z} ${e.w})`)}logPose(t,e){this.logVector3(t+"-pos",e.position),this.logVector4(t+"-rot",e.rotation),this.logValue(t+"-focalDist",e.focalDistance)}showPt(t){if(this.pointDiv)this.pointDiv.style.left=`${t.x}px`,this.pointDiv.style.top=`${t.y}px`;else{this.pointDiv=document.createElement("div");const e=this.pointDiv.style;e.position="fixed",e.width="8px",e.height="8px",e.backgroundColor="#aaffaa",e.left=t.x-4+"px",e.top=t.y-4+"px",e.zIndex="99999",e.pointerEvents="none",e.touchAction="none",document.body.appendChild(this.pointDiv)}}drawValues(){if(!this.debugDiv)return;let t="";for(const[e,i]of this.values.entries())t+=`${e}: ${i}<br>`;this.debugDiv.innerHTML=t}}}}]);